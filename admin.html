<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>ç®¡ç†ç”»é¢ | Deri Hotel Navi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root{--navy:#1a1a2e;--navy-l:#2d2d44;--accent:#0066cc;--accent-h:#0052a3;--accent-bg:rgba(0,102,204,0.06);--accent-bdr:rgba(0,102,204,0.2);--gold:#c9a84c;--gold-dim:#a08030;--gold-bg:rgba(201,168,76,0.08);--gold-border:rgba(201,168,76,0.25);--ink:#1e1e2e;--ink-2:#3a3a4a;--ink-3:#7a7a8a;--bg:#f4f5f7;--bg-2:#ffffff;--bg-3:#eef0f4;--border:rgba(0,0,0,0.1);--border-s:rgba(0,0,0,0.18);--green:#28845a;--green-bg:rgba(40,132,90,0.06);--red:#c0392b;--red-bg:rgba(192,57,43,0.06);--blue:#2c5fa1;--blue-bg:rgba(44,95,161,0.06);--pink:#b05570;--pink-bg:rgba(176,85,112,0.06);--r:3px;--shadow:0 1px 3px rgba(0,0,0,0.08);}
        *{box-sizing:border-box;margin:0;padding:0;}
        body{font-family:system-ui,-apple-system,"Segoe UI","Hiragino Sans","Hiragino Kaku Gothic ProN",sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .hdr{background:var(--navy);position:sticky;top:0;z-index:400;}
        .hdr-inner{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;gap:12px;}
        .hdr-logo{font-size:15px;font-weight:700;color:#fff;}
        .hdr-logo span{color:rgba(255,255,255,0.4);font-weight:400;}
        .hdr-user{font-size:11px;color:rgba(255,255,255,0.4);margin-left:auto;}
        .btn-logout{padding:5px 14px;background:transparent;border:1px solid rgba(255,255,255,0.18);border-radius:var(--r);color:rgba(255,255,255,0.5);font-size:11px;cursor:pointer;font-family:inherit;transition:all 0.2s;min-height:30px;}
        .btn-logout:hover{border-color:var(--red);color:var(--red);}
        /* ã‚¿ãƒ–ãƒãƒ¼ */
        .tab-bar{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch;}
        .tab-link{padding:10px 18px;background:transparent;border:none;border-bottom:2px solid transparent;color:rgba(255,255,255,0.5);font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;transition:all 0.15s;white-space:nowrap;position:relative;}
        .tab-link:hover{color:rgba(255,255,255,0.85);}
        .tab-link.active{color:#fff;border-bottom-color:var(--accent);font-weight:700;}
        .tab-badge{position:absolute;top:2px;right:0;font-size:9px;min-width:16px;height:16px;padding:0 4px;background:var(--red);color:#fff;border-radius:8px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;}
        .hamburger{display:none;}
        .nav-overlay{display:none;}
        /* ãƒ­ã‚°ã‚¤ãƒ³ */
        .login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
        .login-card{background:var(--bg-2);border:1px solid var(--border);border-radius:6px;padding:36px;width:100%;max-width:360px;box-shadow:var(--shadow);}
        .login-title{font-size:18px;font-weight:700;margin-bottom:4px;}
        .login-sub{font-size:12px;color:var(--ink-3);margin-bottom:24px;}
        .f-group{margin-bottom:14px;}
        .f-label{display:block;font-size:11px;font-weight:600;color:var(--ink-3);margin-bottom:5px;letter-spacing:0.3px;}
        .f-input{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--r);font-family:inherit;font-size:14px;outline:none;background:var(--bg-3);transition:border-color 0.2s;}
        .f-input:focus{border-color:var(--accent);background:#fff;}
        .btn-login{width:100%;padding:11px;background:var(--accent);border:none;border-radius:var(--r);color:#fff;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:background 0.2s;}
        .btn-login:hover{background:var(--accent-h);}
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .layout{max-width:1200px;margin:0 auto;padding:20px;}
        .sidebar{display:none;}
        .nav-item{display:none;}
        .nav-badge{display:none;}
        /* ãƒ¡ã‚¤ãƒ³ */
        .main{min-width:0;}
        .tab-panel{display:none;}
        .tab-panel.active{display:block;}
        /* ã‚«ãƒ¼ãƒ‰ */
        .card{background:var(--bg-2);border:1px solid var(--border);border-radius:4px;padding:20px;box-shadow:var(--shadow);margin-bottom:16px;}
        .card-title{font-size:14px;font-weight:700;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
        .card-title .sub{font-size:11px;font-weight:400;color:var(--ink-3);margin-left:auto;}
        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆ */
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px;}
        .stat-box{background:var(--bg-2);border:1px solid var(--border);border-radius:4px;padding:16px 12px;text-align:center;}
        .stat-val{font-size:28px;font-weight:700;color:var(--accent);line-height:1;}
        .stat-lbl{font-size:11px;color:var(--ink-3);margin-top:5px;}
        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
        .tbl{width:100%;border-collapse:collapse;font-size:12px;}
        .tbl th{text-align:left;padding:9px 11px;background:#e8ecef;color:var(--ink-2);font-size:11px;font-weight:700;letter-spacing:0.3px;border-bottom:1px solid var(--border);cursor:pointer;user-select:none;white-space:nowrap;}
        .tbl th:hover{color:var(--ink);}
        .tbl th .sa{margin-left:3px;opacity:0.4;}
        .tbl th.sorted .sa{opacity:1;color:var(--accent);}
        .tbl td{padding:10px 11px;border-bottom:1px solid var(--border);vertical-align:middle;}
        .tbl tr:last-child td{border-bottom:none;}
        .tbl tbody tr:nth-child(even) td{background:#f9fafb;}
        .tbl tbody tr:hover td{background:#f0f4ff;}
        /* ãƒãƒƒã‚¸ */
        .badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:2px;font-size:10px;font-weight:700;border:1px solid;white-space:nowrap;}
        .b-paid{background:var(--gold-bg);color:var(--gold-dim);border-color:var(--gold-border);}
        .b-free{background:var(--bg-3);color:var(--ink-3);border-color:var(--border);}
        .b-active{background:var(--green-bg);color:var(--green);border-color:rgba(40,132,90,0.2);}
        .b-stop{background:var(--red-bg);color:var(--red);border-color:rgba(192,57,43,0.2);}
        .b-can{background:var(--green-bg);color:var(--green);border-color:rgba(40,132,90,0.2);}
        .b-cant{background:var(--red-bg);color:var(--red);border-color:rgba(192,57,43,0.2);}
        .b-men{background:var(--blue-bg);color:var(--blue);border-color:rgba(44,95,161,0.2);}
        .b-women{background:var(--pink-bg);color:var(--pink);border-color:rgba(176,85,112,0.2);}
        .b-shop{background:var(--gold-bg);color:var(--gold-dim);border-color:var(--gold-border);}
        .b-email-pending{background:#fffde7;color:#f9a825;border-color:rgba(249,168,37,0.3);}
        .b-registered{background:#fff3e0;color:#e67e22;border-color:rgba(230,126,34,0.25);}
        .b-suspended{background:var(--bg-3);color:var(--ink-3);border-color:var(--border);}
        .b-published{background:var(--green-bg);color:var(--green);border-color:rgba(40,132,90,0.2);}
        .b-unpublished{background:var(--bg-3);color:var(--ink-3);border-color:var(--border);}
        /* ãƒœã‚¿ãƒ³ */
        .btn{padding:6px 11px;border-radius:var(--r);border:1px solid;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.15s;white-space:nowrap;min-height:30px;}
        .btn:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,0.1);}
        .b-btn-green{background:var(--green-bg);color:var(--green);border-color:rgba(40,132,90,0.25);}
        .b-btn-green:hover{background:var(--green);color:#fff;border-color:var(--green);}
        .b-btn-red{background:var(--red-bg);color:var(--red);border-color:rgba(192,57,43,0.2);}
        .b-btn-red:hover{background:var(--red);color:#fff;border-color:var(--red);}
        .b-btn-gold{background:var(--accent-bg);color:var(--accent);border-color:var(--accent-bdr);}
        .b-btn-gold:hover{background:var(--accent);color:#fff;border-color:var(--accent);}
        .b-btn-gray{background:var(--bg-3);color:var(--ink-3);border-color:var(--border);}
        .b-btn-gray:hover{background:var(--ink-3);color:#fff;border-color:var(--ink-3);}
        .b-btn-blue{background:var(--blue-bg);color:var(--blue);border-color:rgba(44,95,161,0.2);}
        .b-btn-blue:hover{background:var(--blue);color:#fff;border-color:var(--blue);}
        .btn-row{display:flex;gap:5px;flex-wrap:wrap;}
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .filter-bar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center;}
        .filter-select{padding:7px 10px;border:1px solid var(--border);border-radius:var(--r);font-family:inherit;font-size:12px;background:var(--bg-3);outline:none;cursor:pointer;min-height:34px;}
        .filter-select:focus{border-color:var(--accent);}
        .filter-input{padding:7px 10px;border:1px solid var(--border);border-radius:var(--r);font-family:inherit;font-size:12px;background:var(--bg-3);outline:none;flex:1;min-width:150px;min-height:34px;}
        .filter-input:focus{border-color:var(--accent);}
        /* ãƒã‚¹ã‚¿ãƒ¼æ¡ä»¶ãƒªã‚¹ãƒˆ */
        .cond-list{display:flex;flex-direction:column;gap:6px;margin-bottom:13px;}
        .cond-row{display:flex;align-items:center;gap:10px;padding:9px 13px;background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r);}
        .cond-order{font-size:11px;color:var(--ink-3);width:20px;text-align:center;flex-shrink:0;}
        .cond-label{flex:1;font-size:13px;font-weight:500;}
        .add-row{display:flex;gap:8px;}
        .add-input{flex:1;padding:9px 13px;border:1.5px dashed var(--accent);border-radius:var(--r);font-family:inherit;font-size:13px;outline:none;background:var(--accent-bg);}
        .btn-add{padding:9px 18px;background:var(--accent);border:none;border-radius:var(--r);color:#fff;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;min-height:40px;transition:all 0.15s;}
        .btn-add:hover{background:var(--accent-h);transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,0.1);}
        .drag-handle{cursor:grab;font-size:15px;color:var(--ink-3);padding:0 3px;flex-shrink:0;user-select:none;line-height:1;}
        .drag-handle:active{cursor:grabbing;}
        .cond-row.drag-over{border-color:var(--accent);background:var(--accent-bg);}
        .cond-row.dragging{opacity:0.35;border-style:dashed;}
        /* ãƒã‚¹ã‚¿ãƒ¼ã‚µãƒ–ã‚¿ãƒ– */
        .master-tabs{display:flex;gap:4px;margin-bottom:16px;}
        .master-tab{padding:7px 16px;border:1px solid var(--border);border-radius:var(--r);background:var(--bg-3);color:var(--ink-3);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.15s;}
        .master-tab:hover{color:var(--ink);}
        .master-tab.active{background:var(--accent);color:#fff;border-color:var(--accent);}
        .master-sub{display:none;}
        .master-sub.active{display:block;}
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:flex;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;}
        .modal{background:var(--bg-2);border-radius:6px;padding:28px;width:100%;max-width:500px;box-shadow:0 8px 32px rgba(0,0,0,0.18);margin:auto;}
        .modal-title{font-size:16px;font-weight:700;margin-bottom:20px;}
        .mf{margin-bottom:14px;}
        .ml{display:block;font-size:11px;font-weight:600;color:var(--ink-3);margin-bottom:5px;letter-spacing:0.3px;}
        .mi{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--r);font-family:inherit;font-size:13px;outline:none;background:var(--bg-3);}
        .mi:focus{border-color:var(--accent);}
        .modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}
        .btn-save{padding:10px 22px;background:var(--accent);border:none;border-radius:var(--r);color:#fff;font-family:inherit;font-weight:700;cursor:pointer;font-size:13px;min-height:40px;transition:all 0.15s;}
        .btn-save:hover{background:var(--accent-h);transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,0.1);}
        .btn-cancel{padding:10px 18px;background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r);font-family:inherit;font-size:13px;cursor:pointer;color:var(--ink-2);min-height:40px;transition:all 0.15s;}
        .btn-cancel:hover{background:var(--border);transform:translateY(-1px);}
        /* ãƒˆãƒ¼ã‚¹ãƒˆ */
        .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--navy);color:#fff;padding:10px 22px;border-radius:4px;font-size:13px;opacity:0;transition:all 0.3s;z-index:9999;white-space:nowrap;pointer-events:none;}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
        .erow td{text-align:center;color:var(--ink-3);padding:30px;}
        /* ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ */
        .pager{display:flex;align-items:center;justify-content:center;gap:14px;margin-top:14px;}
        .pager-info{font-size:12px;color:var(--ink-3);}
        /* ===== ã‚¹ãƒãƒ›å¯¾å¿œ (768px) ===== */
        @media(max-width:768px){
            /* ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ */
            .test-banner{font-size:11px;padding:6px 10px;}
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
            .hdr-inner{padding:8px 12px;gap:8px;}
            .hdr-logo{font-size:12px;}
            .hdr-user{font-size:10px;}
            .btn-logout{padding:4px 10px;font-size:10px;min-height:26px;}
            /* ã‚¿ãƒ–ãƒãƒ¼ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            .tab-bar{padding:0 8px;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none;}
            .tab-bar::-webkit-scrollbar{display:none;}
            .tab-link{padding:8px 12px;font-size:11px;flex-shrink:0;}
            /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
            .layout{padding:10px;}
            /* ã‚«ãƒ¼ãƒ‰ */
            .card{padding:14px 10px;margin-bottom:10px;}
            .card-title{font-size:13px;gap:6px;margin-bottom:10px;padding-bottom:8px;}
            .card-title .sub{font-size:10px;}
            /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
            .stats-grid{grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px;}
            .stat-val{font-size:22px;}
            .stat-lbl{font-size:10px;}
            /* ãƒ†ãƒ¼ãƒ–ãƒ« */
            .tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
            .tbl{min-width:600px;}
            .tbl th{padding:7px 8px;font-size:10px;}
            .tbl td{padding:8px 8px;font-size:11px;}
            /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
            .filter-bar{gap:6px;}
            .filter-select{font-size:16px;min-height:40px;padding:8px 10px;min-width:0;flex:1 1 calc(50% - 3px);}
            .filter-input{font-size:16px;min-height:40px;padding:8px 10px;min-width:0;flex:1 1 100%;}
            /* ãƒœã‚¿ãƒ³ */
            .btn{min-height:36px;padding:7px 10px;font-size:11px;}
            .btn-row{gap:4px;}
            /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
            .modal-overlay{padding:10px;}
            .modal{padding:18px 14px;max-width:95vw;max-height:90vh;overflow-y:auto;}
            .modal-title{font-size:15px;margin-bottom:14px;}
            .mi{font-size:16px;padding:10px 12px;}
            .ml{font-size:10px;}
            .btn-save{min-height:44px;font-size:14px;padding:10px 16px;}
            .btn-cancel{min-height:44px;font-size:14px;padding:10px 14px;}
            .btn-add{min-height:44px;font-size:14px;}
            .add-input{font-size:14px;}
            /* ãƒã‚¹ã‚¿ã‚µãƒ–ã‚¿ãƒ– */
            .master-tabs{flex-wrap:wrap;gap:4px;}
            .master-tab{font-size:11px;padding:7px 12px;}
            /* ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ */
            .pager{gap:8px;}
            .pager .btn{min-height:38px;}
            /* ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³è¡Œ */
            .cond-row{padding:8px 10px;gap:6px;}
            .cond-label{font-size:12px;}
        }
        /* ===== æ¥µå°ã‚¹ãƒãƒ› (480px) ===== */
        @media(max-width:480px){
            .hdr-inner{padding:6px 8px;gap:6px;}
            .hdr-logo{font-size:11px;}
            .hdr-user{display:none;}
            .btn-logout{font-size:9px;padding:3px 8px;min-height:24px;}
            .tab-link{padding:7px 10px;font-size:10px;}
            .layout{padding:6px;}
            .card{padding:10px 8px;}
            .card-title{font-size:12px;}
            .stats-grid{gap:6px;}
            .stat-box{padding:10px 6px;}
            .stat-val{font-size:18px;}
            .tbl{min-width:520px;}
            .filter-select{flex:1 1 100%;}
            .modal{padding:14px 10px;max-width:100vw;border-radius:0;}
            .modal-overlay{padding:0;}
            .modal-btns{flex-direction:column;}
            .modal-btns .btn-save,.modal-btns .btn-cancel{width:100%;}
            .cond-row .btn{font-size:10px;padding:5px 8px;min-height:30px;}
        }
    </style>
</head>
<body>
<!-- âš ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ -->
<div class="test-banner" style="position:sticky;top:0;z-index:9999;background:#c0392b;color:#fff;text-align:center;padding:8px 16px;font-size:13px;font-weight:700;letter-spacing:0.03em;">
    âš ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šæœ¬ç•ªå‰ã«èªè¨¼ã‚’å¿…ãšæœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„
</div>
<div class="hdr" id="hdr" style="display:none;">
    <div class="hdr-inner">
        <div class="hdr-logo">&#x26E9; Deri Hotel Navi <span>/ ç®¡ç†ç”»é¢</span></div>
        <span class="hdr-user" id="hdr-email"></span>
        <button class="btn-logout" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <nav class="tab-bar" id="tab-bar">
        <button class="tab-link active" onclick="switchTab('dashboard')" id="tl-dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        <button class="tab-link" onclick="switchTab('reports')" id="tl-reports">æŠ•ç¨¿ç®¡ç†<span class="tab-badge" id="rep-badge" style="display:none;"></span></button>
        <button class="tab-link" onclick="switchTab('hotels')" id="tl-hotels">ãƒ›ãƒ†ãƒ«ç·¨é›†</button>
        <button class="tab-link" onclick="switchTab('hotel-requests')" id="tl-hotel-requests">æ²è¼‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<span class="tab-badge" id="hreq-badge" style="display:none;"></span></button>
        <button class="tab-link" onclick="switchTab('shops')" id="tl-shops">ã‚·ãƒ§ãƒƒãƒ—ç®¡ç†<span class="tab-badge" id="shop-badge" style="display:none;"></span></button>
        <button class="tab-link" onclick="switchTab('master')" id="tl-master">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿</button>
    </nav>
</div>
<div class="login-wrap" id="login-wrap" style="display:none;">
    <div class="login-card">
        <div class="login-title">&#x1F510; ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
        <div class="login-sub">Deri Hotel Navi ç®¡ç†ç”»é¢</div>
        <form onsubmit="event.preventDefault();doLogin()" autocomplete="on">
            <div class="f-group"><label class="f-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" id="login-email" name="email" class="f-input" placeholder="admin@example.com" autocomplete="username"></div>
            <div class="f-group"><label class="f-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="login-pw" name="password" class="f-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
            <button type="submit" class="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>
    </div>
</div>
<div class="layout" id="layout" style="display:none;">

    <div class="main">
        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <div class="tab-panel active" id="tab-dashboard">
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-val" id="s-hotels">â€”</div><div class="stat-lbl">ãƒ›ãƒ†ãƒ«æ•°</div></div>
                <div class="stat-box"><div class="stat-val" id="s-reports">â€”</div><div class="stat-lbl">ç·æŠ•ç¨¿æ•°</div></div>
                <div class="stat-box"><div class="stat-val" id="s-shops">â€”</div><div class="stat-lbl">ç™»éŒ²åº—èˆ—</div></div>
                <div class="stat-box"><div class="stat-val" id="s-canrate">â€”</div><div class="stat-lbl">å‘¼ã¹ãŸç‡</div></div>
            </div>
            <div class="card">
                <div class="card-title">&#x1F4C8; æœ€è¿‘ã®æŠ•ç¨¿<span class="sub" id="dash-sub"></span></div>
                <div class="tbl-wrap"><table class="tbl"><thead><tr><th>æ—¥æ™‚</th><th>ãƒ›ãƒ†ãƒ«å</th><th>ãƒ¢ãƒ¼ãƒ‰</th><th>çµæœ</th><th>æ¡ä»¶</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th></tr></thead>
                <tbody id="dash-tbody"></tbody></table></div>
            </div>
        </div>
        <!-- åº—èˆ—ç®¡ç† -->
        <div class="tab-panel" id="tab-shops">
            <div class="card">
                <div class="card-title">&#x1F3EA; åº—èˆ—ä¸€è¦§<span class="sub" id="shops-sub"></span></div>
                <div class="filter-bar">
                    <select class="filter-select" id="shop-mode-f" onchange="renderShops()"><option value="">å…¨ã‚¸ãƒ£ãƒ³ãƒ«</option><option value="men">â™‚ ç”·æ€§å‘ã‘</option><option value="women">â™€ å¥³æ€§å‘ã‘</option><option value="men_same">â™‚â™‚ ç”·æ€§åŒå£«</option><option value="women_same">â™€â™€ å¥³æ€§åŒå£«</option></select>
                    <select class="filter-select" id="shop-appr-f" onchange="renderShops()"><option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option><option value="email_pending">èªè¨¼å¾…</option><option value="registered">æº–å‚™ä¸­</option><option value="active">æ²è¼‰ä¸­</option><option value="suspended">åœæ­¢ä¸­</option><option value="pending">æœªç¢ºèª(æ—§)</option><option value="approved">æ‰¿èªæ¸ˆ(æ—§)</option><option value="denied">å¦èª(æ—§)</option></select>
                    <select class="filter-select" id="shop-plan-f" onchange="renderShops()"><option value="">å…¨ãƒ—ãƒ©ãƒ³</option><option value="free">ç„¡æ–™æ²è¼‰</option><option value="paid">æœ‰æ–™æ²è¼‰</option></select>
                    <input class="filter-input" id="shop-search" placeholder="åº—èˆ—åãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»TELã§æ¤œç´¢..." oninput="renderShops()">
                </div>
                <div class="tbl-wrap"><table class="tbl" id="shops-tbl">
                    <thead><tr>
                        <th onclick="doSort('shops','created_at',renderShops)">ç”³è«‹æ—¥<span class="sa">â†•</span></th>
                        <th onclick="doSort('shops','email',renderShops)">ãƒ¡ãƒ¼ãƒ«<span class="sa">â†•</span></th>
                        <th onclick="doSort('shops','shop_name',renderShops)">åº—èˆ—å<span class="sa">â†•</span></th>
                        <th>ã‚¸ãƒ£ãƒ³ãƒ«</th>
                        <th>å±Šå‡ºæ›¸</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>æ²è¼‰ãƒ—ãƒ©ãƒ³</th>
                        <th>æ“ä½œ</th>
                    </tr></thead>
                    <tbody id="shops-tbody"></tbody>
                </table></div>
            </div>
        </div>
        <!-- æŠ•ç¨¿ç®¡ç†ï¼ˆçµ±åˆï¼‰ -->
        <div class="tab-panel" id="tab-reports">
            <div class="card">
                <div class="card-title">&#x1F4DD; æŠ•ç¨¿ä¸€è¦§<span class="sub" id="reports-sub"></span></div>
                <div class="filter-bar">
                    <select class="filter-select" id="rep-mode-f" onchange="repPage=0;renderReports()"><option value="">å…¨ãƒ¢ãƒ¼ãƒ‰</option><option value="men">â™‚ ç”·æ€§</option><option value="women">â™€ å¥³æ€§</option><option value="men_same">â™‚â™‚ ç”·æ€§åŒå£«</option><option value="women_same">â™€â™€ å¥³æ€§åŒå£«</option></select>
                    <select class="filter-select" id="rep-result-f" onchange="repPage=0;renderReports()"><option value="">å…¨çµæœ</option><option value="can">å‘¼ã¹ãŸ</option><option value="cannot">å‘¼ã¹ãªã‹ã£ãŸ</option></select>
                    <select class="filter-select" id="rep-type-f" onchange="repPage=0;renderReports()"><option value="">å…¨æŠ•ç¨¿è€…</option><option value="user">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼</option><option value="shop_free">ğŸª ç„¡æ–™æ²è¼‰åº—èˆ—</option><option value="shop_paid">â­ æœ‰æ–™æ²è¼‰åº—èˆ—</option></select>
                    <select class="filter-select" id="rep-vis-f" onchange="repPage=0;renderReports()"><option value="">å…¨è¡¨ç¤º</option><option value="visible">è¡¨ç¤ºä¸­</option><option value="hidden">éè¡¨ç¤º</option></select>
                    <select class="filter-select" id="rep-flag-f" onchange="repPage=0;renderReports()"><option value="">å…¨æŠ•ç¨¿</option><option value="flagged">ğŸš© æœªå¯¾å¿œå ±å‘Šã‚ã‚Š</option><option value="resolved">âœ… å¯¾å¿œæ¸ˆã¿å ±å‘Šã‚ã‚Š</option></select>
                    <input class="filter-input" id="rep-hotel-f" placeholder="ãƒ›ãƒ†ãƒ«åã§æ¤œç´¢..." oninput="onRepHotelInput()" style="max-width:180px;">
                </div>
                <div class="tbl-wrap"><table class="tbl">
                    <thead><tr>
                        <th onclick="doSort('reports','created_at',()=>{repPage=0;renderReports();})">æ—¥æ™‚<span class="sa">â†•</span></th>
                        <th onclick="doSort('reports','hotel_name',()=>{repPage=0;renderReports();})">ãƒ›ãƒ†ãƒ«å<span class="sa">â†•</span></th>
                        <th>ãƒ¢ãƒ¼ãƒ‰</th>
                        <th onclick="doSort('reports','can_call',()=>{repPage=0;renderReports();})">çµæœ<span class="sa">â†•</span></th>
                        <th>æŠ•ç¨¿è€…</th>
                        <th>æ¡ä»¶</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>å ±å‘Š</th><th>æ“ä½œ</th>
                    </tr></thead>
                    <tbody id="reports-tbody"></tbody>
                </table></div>
                <div class="pager">
                    <button class="btn b-btn-gray" id="rep-prev" onclick="repChangePage(-1)">â† å‰ã¸</button>
                    <span class="pager-info" id="rep-page-info"></span>
                    <button class="btn b-btn-gray" id="rep-next" onclick="repChangePage(1)">æ¬¡ã¸ â†’</button>
                </div>
            </div>
        </div>
        <!-- ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆçµ±åˆï¼‰ -->
        <div class="tab-panel" id="tab-master">
            <div class="card">
                <div class="card-title">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
                <div class="master-tabs">
                    <button class="master-tab active" id="mt-can" onclick="switchMasterSub('can')">âœ… å‘¼ã¹ãŸç†ç”±</button>
                    <button class="master-tab" id="mt-cannot" onclick="switchMasterSub('cannot')">âŒ å‘¼ã¹ãªã‹ã£ãŸç†ç”±</button>
                    <button class="master-tab" id="mt-room" onclick="switchMasterSub('room')">ğŸ› éƒ¨å±‹ã‚¿ã‚¤ãƒ—</button>
                </div>
                <div class="master-sub active" id="msub-can">
                    <div style="font-size:12px;color:var(--ink-3);margin-bottom:8px;" id="can-reasons-sub"></div>
                    <div class="cond-list" id="can-reasons-list"></div>
                    <div class="add-row">
                        <input id="new-can-reason" class="add-input" placeholder="æ–°ã—ã„ç†ç”±ã‚’å…¥åŠ›..." onkeydown="if(event.key==='Enter')addCanReason()">
                        <button class="btn-add" onclick="addCanReason()">ï¼‹ è¿½åŠ </button>
                    </div>
                </div>
                <div class="master-sub" id="msub-cannot">
                    <div style="font-size:12px;color:var(--ink-3);margin-bottom:8px;" id="cannot-reasons-sub"></div>
                    <div class="cond-list" id="cannot-reasons-list"></div>
                    <div class="add-row">
                        <input id="new-cannot-reason" class="add-input" placeholder="æ–°ã—ã„ç†ç”±ã‚’å…¥åŠ›..." onkeydown="if(event.key==='Enter')addCannotReason()">
                        <button class="btn-add" onclick="addCannotReason()">ï¼‹ è¿½åŠ </button>
                    </div>
                </div>
                <div class="master-sub" id="msub-room">
                    <div style="font-size:12px;color:var(--ink-3);margin-bottom:8px;" id="room-types-sub"></div>
                    <div class="cond-list" id="room-types-list"></div>
                    <div class="add-row">
                        <input id="new-room-type" class="add-input" placeholder="æ–°ã—ã„éƒ¨å±‹ã‚¿ã‚¤ãƒ—ã‚’å…¥åŠ›..." onkeydown="if(event.key==='Enter')addRoomType()">
                        <button class="btn-add" onclick="addRoomType()">ï¼‹ è¿½åŠ </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ãƒ›ãƒ†ãƒ«ç·¨é›† -->
        <div class="tab-panel" id="tab-hotels">
            <div class="card">
                <div class="card-title">&#x1F3E8; ãƒ›ãƒ†ãƒ«æƒ…å ±ç·¨é›†<span class="sub" id="hotels-sub"></span><button class="btn b-btn-gold" style="margin-left:auto;" onclick="openAddHotel()">ï¼‹ ãƒ›ãƒ†ãƒ«è¿½åŠ </button></div>
                <div class="filter-bar">
                    <input class="filter-input" id="hotel-search" placeholder="ãƒ›ãƒ†ãƒ«åãƒ»ä½æ‰€ã§æ¤œç´¢..." oninput="onHotelSearchInput()">
                    <select class="filter-select" id="hotel-pref-f" onchange="fetchHotels()"><option value="">å…¨éƒ½é“åºœçœŒ</option></select>
                    <select class="filter-select" id="hotel-source-f" onchange="fetchHotels()"><option value="">å…¨ã‚½ãƒ¼ã‚¹</option><option value="manual">æ‰‹å‹•è¿½åŠ ã®ã¿</option><option value="rakuten">æ¥½å¤©APIã®ã¿</option></select>
                    <select class="filter-select" id="hotel-pub-f" onchange="fetchHotels()"><option value="">å…¨å…¬é–‹çŠ¶æ…‹</option><option value="true">å…¬é–‹ä¸­</option><option value="false">éå…¬é–‹</option></select>
                </div>
                <div class="tbl-wrap"><table class="tbl">
                    <thead><tr>
                        <th onclick="doSort('hotels','name',renderHotels)">ãƒ›ãƒ†ãƒ«å<span class="sa">â†•</span></th>
                        <th onclick="doSort('hotels','prefecture',renderHotels)">éƒ½é“åºœçœŒ<span class="sa">â†•</span></th>
                        <th onclick="doSort('hotels','nearest_station',renderHotels)">æœ€å¯„é§…<span class="sa">â†•</span></th>
                        <th onclick="doSort('hotels','min_charge',renderHotels)">æ–™é‡‘<span class="sa">â†•</span></th>
                        <th>å…¬é–‹çŠ¶æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr></thead>
                    <tbody id="hotels-tbody"></tbody>
                </table></div>
            </div>
        </div>
        <!-- æ²è¼‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ -->
        <div class="tab-panel" id="tab-hotel-requests">
            <div class="card">
                <div class="card-title">&#x1F4E8; æ²è¼‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<span class="sub" id="hreq-sub"></span></div>
                <div class="filter-bar">
                    <select class="filter-select" id="hreq-status-f" onchange="renderHotelRequests()"><option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option><option value="pending">æœªç¢ºèª</option><option value="confirmed">ç¢ºèªæ¸ˆ</option></select>
                </div>
                <div class="tbl-wrap"><table class="tbl">
                    <thead><tr>
                        <th onclick="doSort('hreq','created_at',renderHotelRequests)">ç”³è«‹æ—¥<span class="sa">â†•</span></th>
                        <th onclick="doSort('hreq','hotel_name',renderHotelRequests)">ãƒ›ãƒ†ãƒ«å<span class="sa">â†•</span></th>
                        <th>ä½æ‰€</th><th>TEL</th><th>ã‚¿ã‚¤ãƒ—</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th>
                    </tr></thead>
                    <tbody id="hreq-tbody"></tbody>
                </table></div>
            </div>
        </div>
    </div>
</div>
<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ›ãƒ†ãƒ«ç·¨é›† -->
<div class="modal-overlay" id="hotel-modal" style="display:none;" onclick="if(event.target===this)closeModal()">
    <div class="modal">
        <div class="modal-title">&#x1F3E8; ãƒ›ãƒ†ãƒ«æƒ…å ±ã‚’ç·¨é›†</div>
        <input type="hidden" id="edit-id">
        <!-- Step1: ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="edit-step1">
            <div class="mf"><label class="ml">ãƒ›ãƒ†ãƒ«å <span style="color:var(--gold);">*</span></label><input id="edit-name" class="mi"></div>
            <div class="mf"><label class="ml">ãƒ›ãƒ†ãƒ«ã‚¿ã‚¤ãƒ— <span style="color:var(--gold);">*</span></label><select id="edit-type" class="mi"><option value="business">ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«</option><option value="city">ã‚·ãƒ†ã‚£ãƒ›ãƒ†ãƒ«</option><option value="resort">ãƒªã‚¾ãƒ¼ãƒˆãƒ›ãƒ†ãƒ«</option><option value="ryokan">æ—…é¤¨</option><option value="pension">ãƒšãƒ³ã‚·ãƒ§ãƒ³</option><option value="minshuku">æ°‘å®¿</option><option value="other">ãã®ä»–</option></select></div>
            <div class="mf"><label class="ml">éƒµä¾¿ç•ªå·</label><input id="edit-postal" class="mi" placeholder="ä¾‹: 160-0022"></div>
            <div class="mf"><label class="ml">éƒ½é“åºœçœŒ <span style="color:var(--gold);">*</span></label><input id="edit-pref" class="mi" placeholder="ä¾‹: æ±äº¬éƒ½"></div>
            <div class="mf"><label class="ml">å¸‚åŒºç”ºæ‘</label><input id="edit-city" class="mi" placeholder="ä¾‹: æ–°å®¿åŒº"></div>
            <div class="mf"><label class="ml">ä½æ‰€ <span style="color:var(--gold);">*</span></label><input id="edit-address" class="mi" placeholder="ä¾‹: æ±äº¬éƒ½æ–°å®¿åŒº..."></div>
            <div class="mf"><label class="ml">é›»è©±ç•ªå·</label><input id="edit-tel" class="mi" placeholder="ä¾‹: 03-xxxx-xxxx"></div>
            <div class="mf"><label class="ml">æœ€å¯„ã‚Šé§…</label><input id="edit-station" class="mi" placeholder="ä¾‹: æ–°å®¿é§…"></div>
            <div class="mf"><label class="ml">ã‚¨ãƒªã‚¢ (major_area)</label><input id="edit-major-area" class="mi" placeholder="ä¾‹: æ±äº¬"></div>
            <div class="mf"><label class="ml">è©³ç´°ã‚¨ãƒªã‚¢ (detail_area)</label><input id="edit-detail-area" class="mi" placeholder="ä¾‹: æ–°å®¿ãƒ»æ­Œèˆä¼ç”º"></div>
            <div class="mf"><label class="ml">ç·¯åº¦</label><input id="edit-lat" class="mi" type="number" step="any" placeholder="ä¾‹: 35.6895"></div>
            <div class="mf"><label class="ml">çµŒåº¦</label><input id="edit-lng" class="mi" type="number" step="any" placeholder="ä¾‹: 139.6917"></div>
            <div class="mf"><button type="button" class="btn b-btn-gold" style="width:100%;padding:10px;font-size:13px;" onclick="geocodeAndFill('edit')">ğŸ“ ä½æ‰€ã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—</button></div>
            <div class="mf"><label class="ml">å‚è€ƒæ–™é‡‘ï¼ˆå††ï¼‰</label><input id="edit-charge" class="mi" type="number" placeholder="ä¾‹: 5000"></div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-save" onclick="editToConfirm()">ç¢ºèªç”»é¢ã¸ â†’</button>
            </div>
        </div>
        <!-- Step2: ç¢ºèª -->
        <div id="edit-step2" style="display:none;">
            <div id="edit-confirm-body" style="background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:16px;font-size:13px;line-height:2;"></div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="editBack()">â† ä¿®æ­£ã™ã‚‹</button>
                <button class="btn-save" onclick="saveHotel()">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>
</div>
<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ›ãƒ†ãƒ«è¿½åŠ  -->
<div class="modal-overlay" id="hotel-add-modal" style="display:none;" onclick="if(event.target===this)closeAddHotel()">
    <div class="modal">
        <div class="modal-title">&#x1F3E8; ãƒ›ãƒ†ãƒ«ã‚’æ–°è¦è¿½åŠ </div>
        <!-- Step1: ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="add-step1">
            <div class="mf"><label class="ml">ãƒ›ãƒ†ãƒ«å <span style="color:var(--gold);">*</span></label><input id="add-name" class="mi" placeholder="ä¾‹: ãƒ›ãƒ†ãƒ«ã‚¢ãƒ«ãƒ•ã‚¡æ–°å®¿"></div>
            <div class="mf"><label class="ml">ãƒ›ãƒ†ãƒ«ã‚¿ã‚¤ãƒ— <span style="color:var(--gold);">*</span></label><select id="add-type" class="mi"><option value="business">ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«</option><option value="city">ã‚·ãƒ†ã‚£ãƒ›ãƒ†ãƒ«</option><option value="resort">ãƒªã‚¾ãƒ¼ãƒˆãƒ›ãƒ†ãƒ«</option><option value="ryokan">æ—…é¤¨</option><option value="pension">ãƒšãƒ³ã‚·ãƒ§ãƒ³</option><option value="minshuku">æ°‘å®¿</option><option value="other">ãã®ä»–</option></select></div>
            <div class="mf"><label class="ml">éƒµä¾¿ç•ªå·</label><input id="add-postal" class="mi" placeholder="ä¾‹: 160-0022"></div>
            <div class="mf"><label class="ml">éƒ½é“åºœçœŒ <span style="color:var(--gold);">*</span></label><input id="add-pref" class="mi" placeholder="ä¾‹: æ±äº¬éƒ½"></div>
            <div class="mf"><label class="ml">å¸‚åŒºç”ºæ‘</label><input id="add-city" class="mi" placeholder="ä¾‹: æ–°å®¿åŒº"></div>
            <div class="mf"><label class="ml">ä½æ‰€ <span style="color:var(--gold);">*</span></label><input id="add-address" class="mi" placeholder="ä¾‹: æ±äº¬éƒ½æ–°å®¿åŒº..."></div>
            <div class="mf"><label class="ml">é›»è©±ç•ªå·</label><input id="add-tel" class="mi" placeholder="ä¾‹: 03-xxxx-xxxx"></div>
            <div class="mf"><label class="ml">æœ€å¯„ã‚Šé§…</label><input id="add-station" class="mi" placeholder="ä¾‹: æ–°å®¿é§…"></div>
            <div class="mf"><label class="ml">ã‚¨ãƒªã‚¢ (major_area)</label><input id="add-major-area" class="mi" placeholder="ä¾‹: æ±äº¬"></div>
            <div class="mf"><label class="ml">è©³ç´°ã‚¨ãƒªã‚¢ (detail_area)</label><input id="add-detail-area" class="mi" placeholder="ä¾‹: æ–°å®¿ãƒ»æ­Œèˆä¼ç”º"></div>
            <div class="mf"><label class="ml">ç·¯åº¦</label><input id="add-lat" class="mi" type="number" step="any" placeholder="ä¾‹: 35.6895"></div>
            <div class="mf"><label class="ml">çµŒåº¦</label><input id="add-lng" class="mi" type="number" step="any" placeholder="ä¾‹: 139.6917"></div>
            <div class="mf"><button type="button" class="btn b-btn-gold" style="width:100%;padding:10px;font-size:13px;" onclick="geocodeAndFill('add')">ğŸ“ ä½æ‰€ã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—</button></div>
            <div class="mf"><label class="ml">å‚è€ƒæ–™é‡‘ï¼ˆå††ï¼‰</label><input id="add-charge" class="mi" type="number" placeholder="ä¾‹: 5000"></div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeAddHotel()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-save" onclick="addHotelToConfirm()">ç¢ºèªç”»é¢ã¸ â†’</button>
            </div>
        </div>
        <!-- Step2: ç¢ºèª -->
        <div id="add-step2" style="display:none;">
            <div id="add-confirm-body" style="background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:16px;font-size:13px;line-height:2;"></div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="addHotelBack()">â† ä¿®æ­£ã™ã‚‹</button>
                <button class="btn-save" onclick="saveNewHotel()">è¿½åŠ ã™ã‚‹</button>
            </div>
        </div>
    </div>
</div>
<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ²è¼‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆç·¨é›†â†’ãƒ›ãƒ†ãƒ«ç™»éŒ² -->
<div class="modal-overlay" id="hreq-edit-modal" style="display:none;" onclick="if(event.target===this)closeHreqEdit()">
    <div class="modal">
        <div class="modal-title">&#x1F3E8; ãƒ›ãƒ†ãƒ«ã¨ã—ã¦ç™»éŒ² <span id="hreq-edit-label" style="font-size:12px;font-weight:400;color:var(--ink-3);"></span></div>
        <input type="hidden" id="hreq-edit-id">
        <!-- Step1: ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="hreq-step1">
            <div class="mf"><label class="ml">ãƒ›ãƒ†ãƒ«å <span style="color:var(--gold);">*</span></label><input id="hreq-edit-name" class="mi" placeholder="ä¾‹: ãƒ›ãƒ†ãƒ«ã‚¢ãƒ«ãƒ•ã‚¡æ–°å®¿"></div>
            <div class="mf"><label class="ml">ä½æ‰€</label><input id="hreq-edit-address" class="mi" placeholder="ä¾‹: æ±äº¬éƒ½æ–°å®¿åŒº..."></div>
            <div class="mf"><label class="ml">é›»è©±ç•ªå·</label><input id="hreq-edit-tel" class="mi" placeholder="ä¾‹: 03-xxxx-xxxx"></div>
            <div class="mf"><label class="ml">ãƒ›ãƒ†ãƒ«ã‚¿ã‚¤ãƒ—</label><select id="hreq-edit-type" class="mi"><option value="business">ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«</option><option value="city">ã‚·ãƒ†ã‚£ãƒ›ãƒ†ãƒ«</option><option value="resort">ãƒªã‚¾ãƒ¼ãƒˆãƒ›ãƒ†ãƒ«</option><option value="ryokan">æ—…é¤¨</option><option value="pension">ãƒšãƒ³ã‚·ãƒ§ãƒ³</option><option value="minshuku">æ°‘å®¿</option><option value="other">ãã®ä»–</option></select></div>
            <div class="mf"><label class="ml">éƒ½é“åºœçœŒ</label><input id="hreq-edit-pref" class="mi" placeholder="ä¾‹: æ±äº¬éƒ½"></div>
            <div class="mf"><label class="ml">å¸‚åŒºç”ºæ‘ / ã‚¨ãƒªã‚¢</label><input id="hreq-edit-area" class="mi" placeholder="ä¾‹: æ–°å®¿åŒº"></div>
            <div class="mf"><label class="ml">æœ€å¯„ã‚Šé§…</label><input id="hreq-edit-station" class="mi" placeholder="ä¾‹: æ–°å®¿é§…"></div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeHreqEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-save" onclick="hreqEditToConfirm()">ç¢ºèªç”»é¢ã¸ â†’</button>
            </div>
        </div>
        <!-- Step2: ç¢ºèª -->
        <div id="hreq-step2" style="display:none;">
            <div id="hreq-confirm-body" style="background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:16px;font-size:13px;line-height:2;"></div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="hreqEditBack()">â† ä¿®æ­£ã™ã‚‹</button>
                <button class="btn-save" onclick="saveHreqAsHotel()">ãƒ›ãƒ†ãƒ«ã«ç™»éŒ²ã™ã‚‹</button>
            </div>
        </div>
    </div>
</div>
<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæŠ•ç¨¿ç·¨é›† -->
<div class="modal-overlay" id="report-edit-modal" style="display:none;" onclick="if(event.target===this)closeRepEditModal()">
    <div class="modal" style="max-width:520px;">
        <div class="modal-title">&#x270F;&#xFE0F; æŠ•ç¨¿ã‚’ç·¨é›† <span id="re-hotel" style="font-size:12px;font-weight:400;color:var(--ink-3);"></span></div>
        <input type="hidden" id="re-id">
        <div class="mf"><label class="ml">çµæœ</label><select id="re-can-call" class="mi" onchange="reToggleReasons(this.value)"><option value="true">âœ… å‘¼ã¹ãŸ</option><option value="false">âŒ å‘¼ã¹ãªã‹ã£ãŸ</option></select></div>
        <div class="mf"><label class="ml">æŠ•ç¨¿è€…å</label><input id="re-poster-name" class="mi"></div>
        <div class="mf"><label class="ml">æ™‚é–“å¸¯</label><input id="re-time-slot" class="mi" placeholder="ä¾‹: å¤œ (18:00~23:00)"></div>
        <div class="mf"><label class="ml">éƒ¨å±‹ã‚¿ã‚¤ãƒ—</label><select id="re-room-type" class="mi"></select></div>
        <div class="mf" id="re-can-wrap"><label class="ml">å‘¼ã¹ãŸç†ç”±</label><div id="re-can-cb" style="background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;display:flex;flex-wrap:wrap;gap:8px 18px;min-height:44px;"></div></div>
        <div class="mf" id="re-cannot-wrap"><label class="ml">å‘¼ã¹ãªã‹ã£ãŸç†ç”±</label><div id="re-cannot-cb" style="background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;display:flex;flex-wrap:wrap;gap:8px 18px;min-height:44px;"></div></div>
        <div class="mf"><label class="ml">ã‚³ãƒ¡ãƒ³ãƒˆ</label><textarea id="re-comment" class="mi" rows="3" style="resize:vertical;"></textarea></div>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeRepEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn-save" onclick="saveRepEdit()">ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
</div>
<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šåº—èˆ—å¯©æŸ» -->
<div class="modal-overlay" id="shop-review-modal" style="display:none;" onclick="if(event.target===this)closeShopReview()">
    <div class="modal" style="max-width:540px;">
        <div class="modal-title">&#x1F3EA; ç”³è«‹ã‚’ç¢ºèªãƒ»ç·¨é›† <span id="sr-email" style="font-size:12px;font-weight:400;color:var(--ink-3);"></span></div>
        <input type="hidden" id="sr-id">
        <div id="sr-doc-wrap" style="margin-bottom:18px;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;background:var(--bg-3);min-height:80px;display:flex;align-items:center;justify-content:center;"></div>
        <div class="mf"><label class="ml">åº—èˆ—å <span style="color:var(--gold);">*</span></label><input id="sr-name" class="mi"></div>
        <div class="mf"><label class="ml">ã‚¸ãƒ£ãƒ³ãƒ«</label><select id="sr-gender" class="mi"><option value="men">ç”·æ€§å‘ã‘ï¼ˆãƒ‡ãƒªãƒ˜ãƒ«ï¼‰</option><option value="women">å¥³æ€§å‘ã‘ï¼ˆå¥³æ€§ç”¨é¢¨ä¿—ï¼‰</option><option value="men_same">ç”·æ€§åŒå£«å‘ã‘</option><option value="women_same">å¥³æ€§åŒå£«å‘ã‘</option></select></div>
        <div class="mf"><label class="ml">TEL</label><input id="sr-tel" class="mi" type="tel"></div>
        <div class="mf"><label class="ml">URL</label><input id="sr-url" class="mi" type="url"></div>
        <div id="sr-deny-wrap" style="display:none;" class="mf">
            <label class="ml">å¦èªç†ç”±ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="sr-deny-reason" class="mi" rows="3" style="resize:vertical;" placeholder="ä¾‹: å±Šå‡ºæ›¸ã®å†…å®¹ãŒç¢ºèªã§ãã¾ã›ã‚“"></textarea>
        </div>
        <div class="modal-btns" style="justify-content:space-between;">
            <button class="btn-cancel" onclick="closeShopReview()">é–‰ã˜ã‚‹</button>
            <div style="display:flex;gap:8px;">
                <button id="sr-deny-btn" class="btn b-btn-red" style="padding:10px 18px;font-size:13px;font-weight:700;min-height:40px;" onclick="showDenyInput()">å¦èª</button>
                <button id="sr-deny-submit-btn" class="btn b-btn-red" style="padding:10px 18px;font-size:13px;font-weight:700;display:none;min-height:40px;" onclick="saveShopDenial()">å¦èªã‚’ç¢ºå®š</button>
                <button class="btn-save" onclick="saveShopApproval()">&#x2705; æ‰¿èªã—ã¦ç™»éŒ²</button>
            </div>
        </div>
    </div>
</div>
<!-- æ²è¼‰ã‚¨ãƒªã‚¢ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="placement-modal" style="display:none;" onclick="if(event.target===this)closePlacementModal()">
    <div class="modal" style="max-width:660px;">
        <div class="modal-title">ğŸ“ æ²è¼‰ã‚¨ãƒªã‚¢ç®¡ç† <span id="pm-shop-name" style="font-size:13px;font-weight:400;color:var(--ink-3);"></span></div>
        <!-- ç¾åœ¨ã®æ²è¼‰ã‚¨ãƒªã‚¢ä¸€è¦§ -->
        <div style="margin-bottom:20px;">
            <div style="font-size:11px;font-weight:700;color:var(--ink-3);letter-spacing:0.3px;margin-bottom:8px;">ç¾åœ¨ã®æ²è¼‰ã‚¨ãƒªã‚¢</div>
            <div class="tbl-wrap" id="pm-list"><div style="text-align:center;padding:20px;color:var(--ink-3);font-size:12px;">èª­ã¿è¾¼ã¿ä¸­...</div></div>
        </div>
        <!-- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div style="border-top:1px solid var(--border);padding-top:18px;">
            <div style="font-size:11px;font-weight:700;color:var(--ink-3);letter-spacing:0.3px;margin-bottom:12px;">æ–°è¦ã‚¨ãƒªã‚¢è¿½åŠ </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                <div class="mf" style="margin-bottom:0;">
                    <label class="ml">ãƒ¬ãƒ™ãƒ« <span style="color:var(--gold);">*</span></label>
                    <select id="pm-level" class="mi">
                        <option value="national">ğŸŒ å…¨å›½</option>
                        <option value="area">ğŸ—¾ ã‚¨ãƒªã‚¢ï¼ˆé–¢æ±/è¿‘ç•¿ç­‰ï¼‰</option>
                        <option value="prefecture">ğŸ“Œ éƒ½é“åºœçœŒ</option>
                        <option value="small_area">ğŸ™ smallã‚¨ãƒªã‚¢ï¼ˆå¸‚åŒºã‚¨ãƒªã‚¢ï¼‰</option>
                        <option value="detail_area">ğŸ” detailã‚¨ãƒªã‚¢ï¼ˆè©³ç´°ã‚¨ãƒªã‚¢ï¼‰</option>
                        <option value="city">ğŸ˜ å¸‚åŒºç”ºæ‘</option>
                    </select>
                </div>
                <div class="mf" style="margin-bottom:0;">
                    <label class="ml">ã‚¨ãƒªã‚¢ã‚³ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label>
                    <input id="pm-target-code" class="mi" placeholder="ä¾‹: tokyo, yokohama">
                </div>
            </div>
            <div class="mf" style="margin-bottom:10px;">
                <label class="ml">å¯¾è±¡ã‚¨ãƒªã‚¢å <span style="color:var(--gold);">*</span></label>
                <input id="pm-target-name" class="mi" placeholder="ä¾‹: æ±äº¬23åŒºã€æ¨ªæµœã€æ± è¢‹ãƒ»èµ¤ç¾½ãƒ»å·£é´¨ãƒ»å¤§å¡š">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
                <div class="mf" style="margin-bottom:0;">
                    <label class="ml">æ²è¼‰é–‹å§‹æ—¥</label>
                    <input id="pm-started-at" class="mi" type="date">
                </div>
                <div class="mf" style="margin-bottom:0;">
                    <label class="ml">æ²è¼‰çµ‚äº†æ—¥ï¼ˆç©ºæ¬„=ç„¡æœŸé™ï¼‰</label>
                    <input id="pm-ended-at" class="mi" type="date">
                </div>
            </div>
            <button class="btn-add" style="width:100%;" onclick="addPlacement()">ï¼‹ ã‚¨ãƒªã‚¢ã‚’è¿½åŠ </button>
        </div>
        <div class="modal-btns" style="margin-top:14px;">
            <button class="btn-cancel" onclick="closePlacementModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>
<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šå±Šå‡ºæ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
<div class="modal-overlay" id="license-modal" style="display:none;" onclick="if(event.target===this)closeLicenseModal()">
    <div class="modal" style="max-width:700px;">
        <div class="modal-title">ğŸ“„ å±Šå‡ºç¢ºèªæ›¸</div>
        <div id="license-img-wrap" style="text-align:center;"></div>
        <div class="modal-btns"><button class="btn-cancel" onclick="closeLicenseModal()">é–‰ã˜ã‚‹</button></div>
    </div>
</div>
<div class="toast" id="toast"></div>
<script>
const SB_URL="https://ojkhwbvoaiaqekxrbpdd.supabase.co";
const SB_KEY="sb_publishable_UqlcQo5CdoPB_1s1ouLX9Q_olbwArKB";
const sb=supabase.createClient(SB_URL,SB_KEY);
const HOTEL_TYPE_LABELS={business:"ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«",city:"ã‚·ãƒ†ã‚£ãƒ›ãƒ†ãƒ«",resort:"ãƒªã‚¾ãƒ¼ãƒˆãƒ›ãƒ†ãƒ«",ryokan:"æ—…é¤¨",pension:"ãƒšãƒ³ã‚·ãƒ§ãƒ³",minshuku:"æ°‘å®¿",other:"ãã®ä»–"};
const HOTEL_SELECT_COLS="id,name,address,prefecture,major_area,nearest_station,tel,min_charge,source,hotel_type,postal_code,city,detail_area,latitude,longitude,is_published";
function toast(msg,d=2500){const el=document.getElementById("toast");el.textContent=msg;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),d);}
function fmtDate(iso){if(!iso)return"â€”";const d=new Date(iso);return`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;}
function fmtShort(iso){return iso?fmtDate(iso).split(" ")[0]:"â€”";}
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
/* --- æœ¬ç•ªèªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰ ---
async function doLogin(){const email=document.getElementById("login-email").value.trim();const pw=document.getElementById("login-pw").value;if(!email||!pw){toast("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}const{data,error}=await sb.auth.signInWithPassword({email,password:pw});if(error){toast("âŒ "+error.message);return;}onLoggedIn(data.user);}
async function doLogout(){await sb.auth.signOut();location.reload();}
function onLoggedIn(user){document.getElementById("login-wrap").style.display="none";document.getElementById("hdr").style.display="block";document.getElementById("layout").style.display="block";document.getElementById("hdr-email").textContent=user.email;loadAll();}
sb.auth.getSession().then(({data})=>{if(data.session)onLoggedIn(data.session.user);});
--- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã«ã“ã“ã¾ã§ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤ã—ã€ä¸‹ã®ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ --- */

// ===== ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šèªè¨¼ã‚¹ã‚­ãƒƒãƒ— =====
function doLogin(){}
function doLogout(){location.reload();}
function onLoggedIn(_user){}
(function(){document.getElementById("login-wrap").style.display="none";document.getElementById("hdr").style.display="block";document.getElementById("layout").style.display="block";document.getElementById("hdr-email").textContent="ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰";loadAll();})();

// ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼
function toggleTabBar(){document.getElementById("tab-bar").classList.toggle("open");}
function openNav(){toggleTabBar();}
function closeNav(){var tb=document.getElementById("tab-bar");if(tb)tb.classList.remove("open");}

function loadAll(){loadDashboard();loadShops();loadReports();loadHotels();loadCanReasons();loadCannotReasons();loadRoomTypes();loadHotelRequests();}
function switchTab(name){document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));document.querySelectorAll(".tab-link").forEach(n=>n.classList.remove("active"));document.getElementById("tab-"+name).classList.add("active");var tl=document.getElementById("tl-"+name);if(tl)tl.classList.add("active");closeNav();}
function switchMasterSub(name){document.querySelectorAll(".master-sub").forEach(s=>s.classList.remove("active"));document.querySelectorAll(".master-tab").forEach(t=>t.classList.remove("active"));document.getElementById("msub-"+name).classList.add("active");document.getElementById("mt-"+name).classList.add("active");}
const sortStates={};
function doSort(ns,key,renderFn){if(!sortStates[ns])sortStates[ns]={key:null,asc:true};if(sortStates[ns].key===key)sortStates[ns].asc=!sortStates[ns].asc;else{sortStates[ns].key=key;sortStates[ns].asc=true;}renderFn();}
function applySortArr(arr,ns){const s=sortStates[ns];if(!s||!s.key)return arr;return[...arr].sort((a,b)=>{let va=a[s.key]??"",vb=b[s.key]??"";if(typeof va==="string"){va=va.toLowerCase();vb=vb.toLowerCase();}if(va<vb)return s.asc?-1:1;if(va>vb)return s.asc?1:-1;return 0;});}

// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
async function loadDashboard(){const[hR,rR,sR,recR]=await Promise.all([sb.from("hotels").select("id",{count:"exact",head:true}),sb.from("reports").select("id,can_call",{count:"exact"}).limit(2000),sb.from("shops").select("id",{count:"exact",head:true}),sb.from("reports").select("id,created_at,can_call,conditions,comment,poster_type,gender_mode,hotels(name)").order("created_at",{ascending:false}).limit(30)]);document.getElementById("s-hotels").textContent=(hR.count||0).toLocaleString();document.getElementById("s-reports").textContent=(rR.count||0).toLocaleString();document.getElementById("s-shops").textContent=(sR.count||0).toLocaleString();const rD=rR.data||[];const canN=rD.filter(r=>r.can_call).length;document.getElementById("s-canrate").textContent=rD.length?Math.round(canN/rD.length*100)+"%":"â€”";const rec=recR.data||[];document.getElementById("dash-sub").textContent=`æœ€æ–°${rec.length}ä»¶`;document.getElementById("dash-tbody").innerHTML=rec.length===0?`<tr class="erow"><td colspan="6">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`:rec.map(r=>`<tr><td style="white-space:nowrap;color:var(--ink-3);font-size:11px;">${fmtDate(r.created_at)}</td><td style="font-size:12px;">${esc(r.hotels?.name||"â€”")}</td><td>${r.gender_mode==="women"?"<span class='badge b-women'>â™€ å¥³æ€§</span>":r.gender_mode==="women_same"?"<span class='badge b-women'>â™€â™€</span>":r.gender_mode==="men_same"?"<span class='badge b-men'>â™‚â™‚</span>":"<span class='badge b-men'>â™‚ ç”·æ€§</span>"}</td><td><span class="badge ${r.can_call?"b-can":"b-cant"}">${r.can_call?"å‘¼ã¹ãŸ":"å‘¼ã¹ãªã‹ã£ãŸ"}</span></td><td style="font-size:11px;color:var(--ink-3);">${(r.conditions||[]).join(", ")||"â€”"}</td><td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(r.comment||"â€”")}</td></tr>`).join("");}

// ===== åº—èˆ—ç®¡ç† =====
let shopsData=[];
const SHOP_GENRE_LABELS={men:"â™‚ ãƒ‡ãƒªãƒ˜ãƒ«",women:"â™€ å¥³é¢¨",men_same:"â™‚â™‚",women_same:"â™€â™€"};
function getShopStatus(s){if(s.status)return s.status;if(s.is_approved)return"active";if(s.denial_reason)return"denied";return"pending";}
function shopStatusBadge(s){const st=getShopStatus(s);switch(st){case"email_pending":return'<span class="badge b-email-pending">èªè¨¼å¾…</span>';case"registered":return'<span class="badge b-registered">æº–å‚™ä¸­</span>';case"active":return'<span class="badge b-active">æ²è¼‰ä¸­</span>';case"suspended":return'<span class="badge b-suspended">åœæ­¢ä¸­</span>';case"denied":return'<span class="badge b-stop">å¦èª</span>';default:return'<span class="badge b-free">æœªç¢ºèª</span>';}}
async function loadShops(){const{data}=await sb.from("shops").select("*").order("created_at",{ascending:false});shopsData=data||[];updateShopBadge();renderShops();}
function updateShopBadge(){const count=shopsData.filter(s=>{const st=getShopStatus(s);return st==="email_pending"||st==="registered";}).length;const b=document.getElementById("shop-badge");if(b){if(count>0){b.style.display="inline";b.textContent=count;}else b.style.display="none";}}
function renderShops(){const mF=document.getElementById("shop-mode-f").value;const aF=document.getElementById("shop-appr-f").value;const pF=document.getElementById("shop-plan-f").value;const qF=document.getElementById("shop-search").value.toLowerCase();let data=shopsData.filter(s=>{if(mF&&s.gender_mode!==mF)return false;const st=getShopStatus(s);if(aF&&aF!==st)return false;if(pF==="free"&&s.plan==="paid")return false;if(pF==="paid"&&s.plan!=="paid")return false;if(qF&&!s.shop_name?.toLowerCase().includes(qF)&&!s.email?.toLowerCase().includes(qF)&&!s.shop_tel?.toLowerCase().includes(qF))return false;return true;});data=applySortArr(data,"shops");const epCount=shopsData.filter(s=>getShopStatus(s)==="email_pending").length;const regCount=shopsData.filter(s=>getShopStatus(s)==="registered").length;const pendingInfo=[];if(epCount>0)pendingInfo.push("èªè¨¼å¾… "+epCount+" ä»¶");if(regCount>0)pendingInfo.push("æº–å‚™ä¸­ "+regCount+" ä»¶");document.getElementById("shops-sub").textContent=`${data.length} ä»¶${pendingInfo.length>0?" ("+pendingInfo.join(" / ")+")":""}`;document.getElementById("shops-tbody").innerHTML=data.length===0?`<tr class="erow"><td colspan="9">è©²å½“ã™ã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`:data.map(s=>{const st=getShopStatus(s);const isPaid=s.plan==="paid";const planBtn=st==="email_pending"?`<span style="color:var(--ink-3);font-size:11px;">â€”</span>`:`<button class="btn ${isPaid?"b-btn-gold":"b-btn-gray"}" onclick="togglePlan(${s.id},'${s.plan||"free"}')">${isPaid?"â˜… æœ‰æ–™":"ç„¡æ–™"}</button>`;const genreCell=`<span style="font-size:11px;">${SHOP_GENRE_LABELS[s.gender_mode]||"â€”"}</span>`;const docCell=s.document_url?`<button class="btn b-btn-gray" style="font-size:10px;" onclick="showLicenseImg('${esc(s.document_url)}')">ğŸ“„ç¢ºèª</button>`:`<span style="color:var(--ink-3);font-size:11px;">â€”</span>`;let actionBtns="";if(st==="email_pending"){actionBtns='<button class="btn b-btn-red" onclick="deleteShop('+s.id+',\''+esc(s.shop_name||s.email||"")+'\')">å‰Šé™¤</button>';}else{actionBtns='<button class="btn b-btn-gold" onclick="openShopReview('+s.id+')">ç·¨é›†</button>';if(st==="registered")actionBtns+='<button class="btn b-btn-green" onclick="approveShop('+s.id+')">æ‰¿èª</button>';if(st==="active")actionBtns+='<button class="btn b-btn-gray" onclick="suspendShop('+s.id+')">åœæ­¢</button>';actionBtns+='<button class="btn b-btn-blue" onclick="openPlacementModal('+s.id+')">ğŸ“</button>';actionBtns+='<button class="btn b-btn-red" onclick="deleteShop('+s.id+',\''+esc(s.shop_name||"")+'\')">å‰Šé™¤</button>';}return`<tr><td style="color:var(--ink-3);font-size:11px;white-space:nowrap;">${fmtShort(s.created_at)}</td><td style="font-size:11px;color:var(--ink-3);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(s.email||"â€”")}</td><td style="font-weight:500;font-size:13px;">${esc(s.shop_name||"â€”")}</td><td>${genreCell}</td><td>${docCell}</td><td>${shopStatusBadge(s)}</td><td>${planBtn}</td><td><div class="btn-row">${actionBtns}</div></td></tr>`;}).join("");}
function showLicenseImg(url){const wrap=document.getElementById("license-img-wrap");const isPdf=url.toLowerCase().includes(".pdf");wrap.innerHTML=isPdf?`<iframe src="${esc(url)}" style="width:100%;height:500px;border:none;"></iframe>`:`<img src="${esc(url)}" style="width:100%;max-height:70vh;object-fit:contain;display:block;">`;document.getElementById("license-modal").style.display="flex";}
function closeLicenseModal(){document.getElementById("license-modal").style.display="none";}
async function approveShop(id){if(!confirm("ã“ã®åº—èˆ—ã‚’æ‰¿èªã—ã¦æ²è¼‰ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ"))return;const{error}=await sb.from("shops").update({status:"active",is_approved:true,denial_reason:null}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}shopsData=shopsData.map(s=>s.id===id?{...s,status:"active",is_approved:true,denial_reason:null}:s);updateShopBadge();renderShops();toast("âœ… æ‰¿èªã—ã¾ã—ãŸï¼ˆæ²è¼‰ä¸­ï¼‰");}
async function suspendShop(id){if(!confirm("ã“ã®åº—èˆ—ã®æ²è¼‰ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"))return;const{error}=await sb.from("shops").update({status:"suspended"}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}shopsData=shopsData.map(s=>s.id===id?{...s,status:"suspended"}:s);renderShops();toast("â¸ åœæ­¢ã—ã¾ã—ãŸ");}
async function deleteShop(id,name){if(!confirm("ã€Œ"+name+"ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚"))return;const{error}=await sb.from("shops").delete().eq("id",id);if(error){toast("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: "+error.message);return;}shopsData=shopsData.filter(s=>s.id!==id);updateShopBadge();renderShops();toast("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");}
let _srId=null;
function openShopReview(id){const s=shopsData.find(s=>s.id===id);if(!s)return;_srId=id;document.getElementById("sr-email").textContent=s.email||"";document.getElementById("sr-name").value=s.shop_name||"";document.getElementById("sr-gender").value=s.gender_mode||"men";document.getElementById("sr-tel").value=s.shop_tel||"";document.getElementById("sr-url").value=s.shop_url||"";document.getElementById("sr-deny-reason").value=s.denial_reason||"";document.getElementById("sr-deny-wrap").style.display="none";document.getElementById("sr-deny-btn").style.display="";document.getElementById("sr-deny-submit-btn").style.display="none";const wrap=document.getElementById("sr-doc-wrap");if(s.document_url){const isPdf=s.document_url.toLowerCase().includes(".pdf");wrap.innerHTML=isPdf?`<iframe src="${esc(s.document_url)}" style="width:100%;height:280px;border:none;"></iframe>`:`<a href="${esc(s.document_url)}" target="_blank" rel="noopener" style="display:block;width:100%;"><img src="${esc(s.document_url)}" style="width:100%;max-height:280px;object-fit:contain;display:block;"></a>`;}else{wrap.innerHTML='<span style="font-size:12px;color:var(--ink-3);padding:24px;">æ›¸é¡ãªã—</span>';}document.getElementById("shop-review-modal").style.display="flex";}
function closeShopReview(){document.getElementById("shop-review-modal").style.display="none";_srId=null;}
function showDenyInput(){document.getElementById("sr-deny-wrap").style.display="";document.getElementById("sr-deny-btn").style.display="none";document.getElementById("sr-deny-submit-btn").style.display="";}
async function saveShopApproval(){if(!_srId)return;const name=document.getElementById("sr-name").value.trim();if(!name){toast("åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}const payload={shop_name:name,gender_mode:document.getElementById("sr-gender").value,shop_tel:document.getElementById("sr-tel").value.trim()||null,shop_url:document.getElementById("sr-url").value.trim()||null,is_approved:true,denial_reason:null,status:"active"};const{error}=await sb.from("shops").update(payload).eq("id",_srId);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}shopsData=shopsData.map(s=>s.id===_srId?{...s,...payload}:s);updateShopBadge();renderShops();closeShopReview();toast("âœ… æ‰¿èªã—ã¾ã—ãŸ");}
async function saveShopDenial(){if(!_srId)return;const reason=document.getElementById("sr-deny-reason").value.trim()||null;const payload={is_approved:false,denial_reason:reason,status:"suspended"};const{error}=await sb.from("shops").update(payload).eq("id",_srId);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}shopsData=shopsData.map(s=>s.id===_srId?{...s,...payload}:s);updateShopBadge();renderShops();closeShopReview();toast("ğŸš« å¦èªã—ã¾ã—ãŸ");}
// ===== æ²è¼‰ã‚¨ãƒªã‚¢ç®¡ç† =====
let placementsData=[];
let _pmShopId=null;
const PM_LEVEL_LABELS={national:"ğŸŒ å…¨å›½",area:"ğŸ—¾ ã‚¨ãƒªã‚¢",prefecture:"ğŸ“Œ éƒ½é“åºœçœŒ",small_area:"ğŸ™ smallã‚¨ãƒªã‚¢",detail_area:"ğŸ” detailã‚¨ãƒªã‚¢",city:"ğŸ˜ å¸‚åŒºç”ºæ‘"};

async function openPlacementModal(shopId){
  _pmShopId=shopId;
  const shop=shopsData.find(s=>s.id===shopId);
  document.getElementById("pm-shop-name").textContent=shop?("â€” "+esc(shop.shop_name||"")):"";
  document.getElementById("pm-level").value="national";
  document.getElementById("pm-target-code").value="";
  document.getElementById("pm-target-name").value="";
  document.getElementById("pm-started-at").value=new Date().toISOString().split("T")[0];
  document.getElementById("pm-ended-at").value="";
  document.getElementById("placement-modal").style.display="flex";
  await loadPlacements(shopId);
}
function closePlacementModal(){document.getElementById("placement-modal").style.display="none";_pmShopId=null;placementsData=[];}

async function loadPlacements(shopId){
  document.getElementById("pm-list").innerHTML='<div style="text-align:center;padding:20px;color:var(--ink-3);font-size:12px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
  const{data,error}=await sb.from("shop_placements").select("*").eq("shop_id",shopId).order("created_at",{ascending:false});
  if(error){document.getElementById("pm-list").innerHTML=`<div style="color:var(--red);font-size:12px;padding:10px;">å–å¾—ã‚¨ãƒ©ãƒ¼: ${esc(error.message)}</div>`;return;}
  placementsData=data||[];
  renderPlacements();
}

function renderPlacements(){
  const el=document.getElementById("pm-list");
  if(!placementsData.length){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--ink-3);font-size:12px;">æ²è¼‰ã‚¨ãƒªã‚¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';return;}
  const now=new Date();
  el.innerHTML=`<table class="tbl"><thead><tr>
    <th>ãƒ¬ãƒ™ãƒ«</th><th>ã‚¨ãƒªã‚¢å</th><th>ã‚³ãƒ¼ãƒ‰</th><th>æœŸé–“</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
  </tr></thead><tbody>${placementsData.map(p=>{
    const ended=p.ended_at&&new Date(p.ended_at)<now;
    const statusLabel=ended?"æœŸé™åˆ‡ã‚Œ":p.is_active?"âœ“ æœ‰åŠ¹":"åœæ­¢ä¸­";
    const statusStyle=p.is_active&&!ended?"color:var(--green);font-weight:700;":"color:var(--ink-3);";
    const period=`${p.started_at?fmtShort(p.started_at):"â€”"} ã€œ ${p.ended_at?fmtShort(p.ended_at):"ç„¡æœŸé™"}`;
    return`<tr style="${!p.is_active||ended?"opacity:0.6;":""}">
      <td><span class="badge b-free" style="font-size:10px;">${esc(PM_LEVEL_LABELS[p.level]||p.level)}</span></td>
      <td style="font-weight:500;">${esc(p.target_name||"ï¼ˆå…¨å›½ï¼‰")}</td>
      <td style="color:var(--ink-3);font-size:11px;">${esc(p.target_code||"â€”")}</td>
      <td style="color:var(--ink-3);font-size:11px;white-space:nowrap;">${period}</td>
      <td style="${statusStyle}font-size:11px;">${statusLabel}</td>
      <td><div class="btn-row">
        <button class="btn ${p.is_active?"b-btn-gray":"b-btn-green"}" onclick="togglePlacement(${p.id},${p.is_active})">${p.is_active?"åœæ­¢":"å†é–‹"}</button>
        <button class="btn b-btn-red" onclick="deletePlacement(${p.id})">å‰Šé™¤</button>
      </div></td>
    </tr>`;
  }).join("")}</tbody></table>`;
}

async function addPlacement(){
  if(!_pmShopId)return;
  const targetName=document.getElementById("pm-target-name").value.trim();
  if(!targetName){toast("ã‚¨ãƒªã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  const level=document.getElementById("pm-level").value;
  const targetCode=document.getElementById("pm-target-code").value.trim()||null;
  const startedAt=document.getElementById("pm-started-at").value;
  const endedAt=document.getElementById("pm-ended-at").value;
  const payload={
    shop_id:_pmShopId,level,target_code:targetCode,target_name:targetName,is_active:true,
    started_at:startedAt?new Date(startedAt).toISOString():new Date().toISOString(),
    ended_at:endedAt?new Date(endedAt).toISOString():null
  };
  const{error}=await sb.from("shop_placements").insert(payload);
  if(error){toast("è¿½åŠ ã‚¨ãƒ©ãƒ¼: "+error.message);return;}
  toast("âœ… ã‚¨ãƒªã‚¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
  document.getElementById("pm-target-name").value="";
  document.getElementById("pm-target-code").value="";
  document.getElementById("pm-ended-at").value="";
  await loadPlacements(_pmShopId);
}

async function togglePlacement(id,current){
  const{error}=await sb.from("shop_placements").update({is_active:!current}).eq("id",id);
  if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}
  placementsData=placementsData.map(p=>p.id===id?{...p,is_active:!current}:p);
  renderPlacements();toast(current?"â¸ åœæ­¢ã—ã¾ã—ãŸ":"âœ… å†é–‹ã—ã¾ã—ãŸ");
}

async function deletePlacement(id){
  if(!confirm("ã“ã®ã‚¨ãƒªã‚¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
  const{error}=await sb.from("shop_placements").delete().eq("id",id);
  if(error){toast("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: "+error.message);return;}
  placementsData=placementsData.filter(p=>p.id!==id);
  renderPlacements();toast("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");
}

async function togglePlan(id,currentPlan){const newPlan=currentPlan==="paid"?"free":"paid";const{error}=await sb.from("shops").update({plan:newPlan}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}shopsData=shopsData.map(s=>s.id===id?{...s,plan:newPlan}:s);renderShops();toast(newPlan==="paid"?"â˜… æœ‰æ–™æ²è¼‰ã«å¤‰æ›´":"ç„¡æ–™æ²è¼‰ã«å¤‰æ›´");}

// ===== æŠ•ç¨¿ç®¡ç†ï¼ˆçµ±åˆï¼‰ =====
let reportsData=[];
async function loadReports(){
  // å…¨ä»¶å–å¾—ï¼ˆlimit:2000ï¼‰+ flagged_atã‚ã‚Šåˆ†ã‚’åˆ¥é€”ç¢ºä¿ï¼ˆlimitè¶…ãˆã¦ã‚‚æ¼ã‚Œãªã„ã‚ˆã†ï¼‰
  const[r1,r2]=await Promise.all([
    sb.from("reports").select("*,hotels(name)").order("created_at",{ascending:false}).limit(2000),
    sb.from("reports").select("*,hotels(name)").not("flagged_at","is",null).order("created_at",{ascending:false})
  ]);
  if(r1.error&&r2.error){toast("âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: "+r1.error.message);console.error("[loadReports]",r1.error);return;}
  const all=r1.data||[];
  const flagged=r2.data||[];
  // flaggedã‚’ãƒ™ãƒ¼ã‚¹ã«ã€allã§å–å¾—ã—ãŸæ®‹ã‚Šã‚’è¿½åŠ ï¼ˆé‡è¤‡æ’é™¤ï¼‰
  const allIds=new Set(all.map(r=>r.id));
  const extra=flagged.filter(r=>!allIds.has(r.id)); // 2000ä»¶è¶…ã®æ——ä»˜ã
  const merged=[...extra,...all];
  // æ——ä»˜ãã‚’å…ˆé ­ã‚½ãƒ¼ãƒˆ
  merged.sort((a,b)=>{
    const af=a.flagged_at&&!a.flag_resolved?0:1;
    const bf=b.flagged_at&&!b.flag_resolved?0:1;
    return af-bf||new Date(b.created_at)-new Date(a.created_at);
  });
  reportsData=merged.map(r=>({...r,hotel_name:r.hotels?.name||"",hotel_mode:r.gender_mode||"men",is_hidden:r.is_hidden||false}));
  console.log("[loadReports]",{total:reportsData.length,unresolved:reportsData.filter(r=>r.flagged_at&&!r.flag_resolved).length});
  updateFlagBadge();renderReports();
}
function updateFlagBadge(){const count=reportsData.filter(r=>r.flagged_at&&!r.flag_resolved).length;console.log("[updateFlagBadge] æœªå¯¾å¿œå ±å‘Šä»¶æ•°:",count,"/ ç·æŠ•ç¨¿:",reportsData.length);const badge=document.getElementById("rep-badge");if(count>0){badge.style.display="inline";badge.textContent=count;}else badge.style.display="none";}
async function resolveFlag(id){const{error}=await sb.from("reports").update({flag_resolved:new Date().toISOString()}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}reportsData=reportsData.map(r=>r.id===id?{...r,flag_resolved:new Date().toISOString()}:r);updateFlagBadge();renderReports();toast("âœ… å¯¾å¿œæ¸ˆã¿ã«ã—ã¾ã—ãŸ");}
async function unresolveFlag(id){const{error}=await sb.from("reports").update({flag_resolved:null}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}reportsData=reportsData.map(r=>r.id===id?{...r,flag_resolved:null}:r);updateFlagBadge();renderReports();toast("ğŸ”„ æœªå¯¾å¿œã«æˆ»ã—ã¾ã—ãŸ");}
let repPage=0;const REP_PER_PAGE=30;
let _repHotelTimer=null;function onRepHotelInput(){clearTimeout(_repHotelTimer);_repHotelTimer=setTimeout(()=>{repPage=0;renderReports();},500);}
function getRepFiltered(){const mF=document.getElementById("rep-mode-f").value;const rF=document.getElementById("rep-result-f").value;const tF=document.getElementById("rep-type-f").value;const vF=document.getElementById("rep-vis-f").value;const fF=document.getElementById("rep-flag-f").value;const hF=document.getElementById("rep-hotel-f")?.value.trim()||"";return reportsData.filter(r=>{if(mF&&r.hotel_mode!==mF)return false;if(rF==="can"&&!r.can_call)return false;if(rF==="cannot"&&r.can_call)return false;if(tF==="user"&&r.poster_type==="shop")return false;if(tF==="shop_free"){if(r.poster_type!=="shop")return false;const shop=shopsData.find(s=>s.shop_name?.toLowerCase()===r.poster_name?.toLowerCase());if(shop?.plan==="paid")return false;}if(tF==="shop_paid"){if(r.poster_type!=="shop")return false;const shop=shopsData.find(s=>s.shop_name?.toLowerCase()===r.poster_name?.toLowerCase());if(shop?.plan!=="paid")return false;}if(vF==="visible"&&r.is_hidden)return false;if(vF==="hidden"&&!r.is_hidden)return false;if(fF==="flagged"&&!(r.flagged_at&&!r.flag_resolved))return false;if(fF==="resolved"&&!(r.flagged_at&&r.flag_resolved))return false;if(hF){const words=hF.split(/[\sã€€]+/).filter(w=>w.length>0);const name=(r.hotel_name||"").toLowerCase();if(!words.every(w=>name.includes(w.toLowerCase())))return false;}return true;});}
function renderReports(){let data=getRepFiltered();data=applySortArr(data,"reports");const total=data.length;const totalPages=Math.max(1,Math.ceil(total/REP_PER_PAGE));if(repPage>=totalPages)repPage=totalPages-1;const page=data.slice(repPage*REP_PER_PAGE,(repPage+1)*REP_PER_PAGE);console.log("[renderReports]",{filtered:total,page:page.length,flaggedInPage:page.filter(r=>r.flagged_at&&!r.flag_resolved).length});document.getElementById("reports-sub").textContent=`${total} ä»¶`;const pi=document.getElementById("rep-page-info");if(pi)pi.textContent=`${repPage+1} / ${totalPages} ãƒšãƒ¼ã‚¸`;const prev=document.getElementById("rep-prev");const next=document.getElementById("rep-next");if(prev)prev.disabled=repPage===0;if(next)next.disabled=repPage>=totalPages-1;document.getElementById("reports-tbody").innerHTML=page.length===0?`<tr class="erow"><td colspan="9">è©²å½“ã™ã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`:page.map(r=>{const isUnresolved=r.flagged_at&&!r.flag_resolved;const rowStyle=r.is_hidden?"opacity:0.45;":"";const rowFlagStyle=isUnresolved?"background:rgba(192,80,80,0.08);border-left:3px solid var(--red);":"";return`<tr style="${rowStyle}${rowFlagStyle}"><td style="white-space:nowrap;color:var(--ink-3);font-size:11px;">${fmtDate(r.created_at)}</td><td style="font-size:12px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(r.hotel_name||"â€”")}</td><td>${r.hotel_mode==="women"?"<span class='badge b-women'>â™€</span>":r.hotel_mode==="women_same"?"<span class='badge b-women'>â™€â™€</span>":r.hotel_mode==="men_same"?"<span class='badge b-men'>â™‚â™‚</span>":"<span class='badge b-men'>â™‚</span>"}</td><td><span class="badge ${r.can_call?"b-can":"b-cant"}">${r.can_call?"å‘¼ã¹ãŸ":"å‘¼ã¹ãªã‹ã£ãŸ"}</span></td><td><span class="badge ${r.poster_type==="shop"?"b-shop":""}">${r.poster_type==="shop"?"ğŸª åº—èˆ—":"ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼"}</span></td><td style="font-size:11px;color:var(--ink-3);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${(r.conditions||[]).join(", ")||"â€”"}</td><td style="font-size:11px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(r.comment||"â€”")}</td><td style="font-size:11px;min-width:140px;">${r.flagged_at&&!r.flag_resolved?`<span style="color:#c05050;font-weight:700;">ğŸš© ${esc(r.flag_reason||"ï¼ˆç†ç”±ãªã—ï¼‰")}</span>${r.flag_comment?`<br><span style="color:var(--ink-3);font-size:10px;word-break:break-all;">${esc(r.flag_comment)}</span>`:"<br>"}<span style="color:var(--ink-3);font-size:10px;">${fmtDate(r.flagged_at)}</span><br><button class="btn b-btn-red" style="margin-top:4px;font-size:10px;" onclick="resolveFlag('${r.id}')">å¯¾å¿œæ¸ˆã¿ã«ã™ã‚‹</button>`:r.flagged_at?`<span style="color:var(--green);font-size:11px;font-weight:600;">âœ… å¯¾å¿œæ¸ˆã¿</span><br><span style="color:var(--ink-3);font-size:10px;">${esc(r.flag_reason||"")}</span>${r.flag_comment?`<br><span style="color:var(--ink-3);font-size:10px;word-break:break-all;">${esc(r.flag_comment)}</span>`:""}<br><span style="color:var(--ink-3);font-size:10px;">${fmtDate(r.flagged_at)}</span><br><button class="btn b-btn-gray" style="margin-top:4px;font-size:10px;" onclick="unresolveFlag('${r.id}')">æœªå¯¾å¿œã«æˆ»ã™</button>`:"â€”"}</td><td><div class="btn-row"><button class="btn b-btn-gold" onclick="openRepEdit('${r.id}')">âœï¸ ç·¨é›†</button><button class="btn ${r.is_hidden?"b-btn-green":"b-btn-gray"}" onclick="toggleVis('${r.id}',${r.is_hidden})">${r.is_hidden?"è¡¨ç¤º":"éè¡¨ç¤º"}</button><button class="btn b-btn-red" onclick="delReport('${r.id}')">å‰Šé™¤</button></div></td></tr>`;}).join("");}
function repChangePage(delta){repPage+=delta;renderReports();}
function openRepEdit(id){const r=reportsData.find(r=>r.id===id);if(!r)return;document.getElementById("re-id").value=id;document.getElementById("re-hotel").textContent=r.hotel_name||"â€”";document.getElementById("re-can-call").value=r.can_call?"true":"false";document.getElementById("re-poster-name").value=r.poster_name||"";document.getElementById("re-time-slot").value=r.time_slot||"";document.getElementById("re-comment").value=r.comment||"";const rtSel=document.getElementById("re-room-type");const rtOpts=roomTypesData.length?roomTypesData.map(t=>t.label):["ã‚·ãƒ³ã‚°ãƒ«","ã‚»ãƒŸãƒ€ãƒ–ãƒ«","ãƒ€ãƒ–ãƒ«","ãƒ„ã‚¤ãƒ³","å’Œå®¤","ãã®ä»–"];rtSel.innerHTML='<option value="">æœªé¸æŠ</option>'+rtOpts.map(l=>`<option value="${esc(l)}"${r.room_type===l?" selected":""}>${esc(l)}</option>`).join("");if(r.room_type&&!rtOpts.includes(r.room_type)){const o=document.createElement("option");o.value=r.room_type;o.textContent=r.room_type;o.selected=true;rtSel.appendChild(o);}const canLabels=canReasonsData.length?canReasonsData.map(c=>c.label):["ç›´é€š","ã‚«ãƒ¼ãƒ‰ã‚­ãƒ¼å¿…é ˆ","EVãƒ•ãƒ­ãƒ³ãƒˆéšã‚¹ã‚­ãƒƒãƒ—","ãƒ•ãƒ­ãƒ³ãƒˆç›¸è«‡","ãƒã‚¦ãƒã‚¦","ãƒã‚¹ã‚¿ã‚ªãƒ«ä¾é ¼æ¨å¥¨","ç„é–¢å¾…ã¡åˆã‚ã›"];const cannotLabels=cannotReasonsData.length?cannotReasonsData.map(c=>c.label):["ãƒ•ãƒ­ãƒ³ãƒˆSTOP","é˜²çŠ¯ã‚«ãƒ¡ãƒ©ç¢ºèª","æ·±å¤œå¤–å‡ºNG","ãã®ä»–"];const selCan=r.can_call_reasons||[];const selCannot=r.cannot_call_reasons||[];document.getElementById("re-can-cb").innerHTML=canLabels.map(l=>`<label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;white-space:nowrap;"><input type="checkbox" value="${esc(l)}"${selCan.includes(l)?" checked":""}> ${esc(l)}</label>`).join("");document.getElementById("re-cannot-cb").innerHTML=cannotLabels.map(l=>`<label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;white-space:nowrap;"><input type="checkbox" value="${esc(l)}"${selCannot.includes(l)?" checked":""}> ${esc(l)}</label>`).join("");reToggleReasons(r.can_call?"true":"false");document.getElementById("report-edit-modal").style.display="flex";}
function reToggleReasons(v){document.getElementById("re-can-wrap").style.display=v==="true"?"":"none";document.getElementById("re-cannot-wrap").style.display=v==="false"?"":"none";}
function closeRepEditModal(){document.getElementById("report-edit-modal").style.display="none";}
async function saveRepEdit(){const id=document.getElementById("re-id").value;const can_call=document.getElementById("re-can-call").value==="true";const poster_name=document.getElementById("re-poster-name").value.trim();const time_slot=document.getElementById("re-time-slot").value.trim()||null;const room_type=document.getElementById("re-room-type").value||null;const comment=document.getElementById("re-comment").value.trim()||null;const can_call_reasons=[...document.querySelectorAll("#re-can-cb input:checked")].map(c=>c.value);const cannot_call_reasons=[...document.querySelectorAll("#re-cannot-cb input:checked")].map(c=>c.value);const payload={can_call,poster_name,time_slot,room_type,comment,can_call_reasons,cannot_call_reasons};const{error}=await sb.from("reports").update(payload).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}reportsData=reportsData.map(r=>r.id===id?{...r,...payload}:r);renderReports();closeRepEditModal();toast("âœ… æ›´æ–°ã—ã¾ã—ãŸ");}
async function toggleVis(id,cur){const{error}=await sb.from("reports").update({is_hidden:!cur}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼");return;}reportsData=reportsData.map(r=>r.id===id?{...r,is_hidden:!cur}:r);renderReports();toast(cur?"âœ… è¡¨ç¤ºã«æˆ»ã—ã¾ã—ãŸ":"â¸ éè¡¨ç¤ºã«ã—ã¾ã—ãŸ");}
async function delReport(id){if(!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚"))return;const{error}=await sb.from("reports").delete().eq("id",id);if(error){toast("å‰Šé™¤ã‚¨ãƒ©ãƒ¼");return;}reportsData=reportsData.filter(r=>r.id!==id);updateFlagBadge();renderReports();toast("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");}

// ===== ãƒ›ãƒ†ãƒ«ç·¨é›† =====
let hotelsData=[];let _hotelSearchTimer=null;
// ===== ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° =====
async function geocodeAddress(address){
  // å‰å‡¦ç†: å…¨è§’æ•°å­—â†’åŠè§’ã€å…¨è§’ãƒã‚¤ãƒ•ãƒ³â†’åŠè§’ã€ä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
  let normalized=address
    .replace(/[ï¼-ï¼™]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0))
    .replace(/[ãƒ¼âˆ’â€”â€“]/g,"-")
    .replace(/\s+/g," ").trim();
  // 1. Nominatimã§è©¦è¡Œ
  try{
    const res=await fetch("https://nominatim.openstreetmap.org/search?"+new URLSearchParams({q:normalized,format:"json",limit:1,countrycodes:"jp"}),{headers:{"Accept-Language":"ja"}});
    const data=await res.json();
    if(data.length>0)return{lat:parseFloat(data[0].lat),lng:parseFloat(data[0].lon)};
  }catch(e){}
  // 2. å›½åœŸåœ°ç†é™¢APIã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  try{
    const res2=await fetch("https://msearch.gsi.go.jp/address-search/AddressSearch?q="+encodeURIComponent(normalized));
    const data2=await res2.json();
    if(data2.length>0&&data2[0].geometry&&data2[0].geometry.coordinates){
      return{lat:data2[0].geometry.coordinates[1],lng:data2[0].geometry.coordinates[0]};
    }
  }catch(e){}
  return null;
}
async function geocodeAndFill(prefix){
  const addr=document.getElementById(prefix+"-address").value.trim();
  if(!addr){toast("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„");return;}
  const btn=event.target;
  const origText=btn.textContent;
  btn.disabled=true;btn.textContent="å–å¾—ä¸­...";
  try{
    const result=await geocodeAddress(addr);
    if(result){
      document.getElementById(prefix+"-lat").value=result.lat;
      document.getElementById(prefix+"-lng").value=result.lng;
      toast("ğŸ“ ç·¯åº¦çµŒåº¦ã‚’å–å¾—ã—ã¾ã—ãŸ");
    }else{
      toast("ä½æ‰€ã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    }
  }catch(e){
    console.error("[geocode]",e);
    toast("å–å¾—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  }finally{
    btn.disabled=false;btn.textContent=origText;
  }
}

async function loadHotels(){const{data}=await sb.from("hotels").select(HOTEL_SELECT_COLS).order("name").limit(500);hotelsData=data||[];const prefs=[...new Set(hotelsData.map(h=>h.prefecture).filter(Boolean))].sort();const sel=document.getElementById("hotel-pref-f");prefs.forEach(p=>{const o=document.createElement("option");o.value=p;o.textContent=p;sel.appendChild(o);});renderHotels();}
function onHotelSearchInput(){clearTimeout(_hotelSearchTimer);_hotelSearchTimer=setTimeout(fetchHotels,400);}
async function fetchHotels(){
  const q=document.getElementById("hotel-search").value.trim();
  const pF=document.getElementById("hotel-pref-f").value;
  const sF=document.getElementById("hotel-source-f").value;
  const pubF=document.getElementById("hotel-pub-f").value;
  let query=sb.from("hotels").select(HOTEL_SELECT_COLS).order("name").limit(200);
  if(q)query=query.ilike("name",`%${q}%`);
  if(pF)query=query.eq("prefecture",pF);
  if(sF)query=query.eq("source",sF);
  if(pubF==="true")query=query.eq("is_published",true);
  if(pubF==="false")query=query.eq("is_published",false);
  const{data}=await query;hotelsData=data||[];renderHotels();
}
function renderHotels(){const data=applySortArr(hotelsData,"hotels");document.getElementById("hotels-sub").textContent=`${data.length} ä»¶`;document.getElementById("hotels-tbody").innerHTML=data.length===0?`<tr class="erow"><td colspan="6">è©²å½“ã™ã‚‹ãƒ›ãƒ†ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`:data.map(h=>{const pub=h.is_published!==false;const pubBadge=pub?'<span class="badge b-published">å…¬é–‹ä¸­</span>':'<span class="badge b-unpublished">éå…¬é–‹</span>';const pubBtn=pub?`<button class="btn b-btn-gray" onclick="togglePublish(${h.id},true)">éå…¬é–‹ã«ã™ã‚‹</button>`:`<button class="btn b-btn-green" onclick="togglePublish(${h.id},false)">å…¬é–‹ã™ã‚‹</button>`;return`<tr><td style="font-weight:500;font-size:13px;">${esc(h.name)}</td><td style="font-size:12px;color:var(--ink-3);">${esc(h.prefecture||"â€”")}</td><td style="font-size:12px;color:var(--ink-3);">${esc(h.nearest_station||"â€”")}</td><td style="font-size:12px;color:var(--ink-3);">${h.min_charge?"Â¥"+parseInt(h.min_charge).toLocaleString()+"~":"â€”"}</td><td>${pubBadge}</td><td><div class="btn-row">${pubBtn}<button class="btn b-btn-gold" onclick="openEdit(${h.id})">âœï¸ ç·¨é›†</button><button class="btn b-btn-red" onclick="deleteHotel(${h.id},'${esc(h.name)}')">å‰Šé™¤</button></div></td></tr>`;}).join("");}
function openEdit(id){const h=hotelsData.find(h=>h.id===id);if(!h)return;document.getElementById("edit-id").value=h.id;document.getElementById("edit-name").value=h.name||"";document.getElementById("edit-type").value=h.hotel_type||"other";document.getElementById("edit-postal").value=h.postal_code||"";document.getElementById("edit-pref").value=h.prefecture||"";document.getElementById("edit-city").value=h.city||"";document.getElementById("edit-address").value=h.address||"";document.getElementById("edit-tel").value=h.tel||"";document.getElementById("edit-station").value=h.nearest_station||"";document.getElementById("edit-major-area").value=h.major_area||"";document.getElementById("edit-detail-area").value=h.detail_area||"";document.getElementById("edit-lat").value=h.latitude||"";document.getElementById("edit-lng").value=h.longitude||"";document.getElementById("edit-charge").value=h.min_charge||"";document.getElementById("edit-step1").style.display="";document.getElementById("edit-step2").style.display="none";document.getElementById("hotel-modal").style.display="flex";}
function closeModal(){document.getElementById("hotel-modal").style.display="none";}
function editToConfirm(){const name=document.getElementById("edit-name").value.trim();if(!name){toast("ãƒ›ãƒ†ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}if(!document.getElementById("edit-address").value.trim()){toast("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}if(!document.getElementById("edit-pref").value.trim()){toast("éƒ½é“åºœçœŒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}const rows=[["ãƒ›ãƒ†ãƒ«å",name],["ã‚¿ã‚¤ãƒ—",HOTEL_TYPE_LABELS[document.getElementById("edit-type").value]||"â€”"],["éƒµä¾¿ç•ªå·",document.getElementById("edit-postal").value.trim()||"â€”"],["éƒ½é“åºœçœŒ",document.getElementById("edit-pref").value.trim()||"â€”"],["å¸‚åŒºç”ºæ‘",document.getElementById("edit-city").value.trim()||"â€”"],["ä½æ‰€",document.getElementById("edit-address").value.trim()||"â€”"],["é›»è©±ç•ªå·",document.getElementById("edit-tel").value.trim()||"â€”"],["æœ€å¯„ã‚Šé§…",document.getElementById("edit-station").value.trim()||"â€”"],["ã‚¨ãƒªã‚¢",document.getElementById("edit-major-area").value.trim()||"â€”"],["è©³ç´°ã‚¨ãƒªã‚¢",document.getElementById("edit-detail-area").value.trim()||"â€”"],["ç·¯åº¦",document.getElementById("edit-lat").value||"â€”"],["çµŒåº¦",document.getElementById("edit-lng").value||"â€”"],["å‚è€ƒæ–™é‡‘",document.getElementById("edit-charge").value?("Â¥"+parseInt(document.getElementById("edit-charge").value).toLocaleString()):"â€”"]];document.getElementById("edit-confirm-body").innerHTML=rows.map(([l,v])=>`<div><span style="color:var(--ink-3);font-size:11px;min-width:80px;display:inline-block;">${l}</span><strong>${esc(v)}</strong></div>`).join("");document.getElementById("edit-step1").style.display="none";document.getElementById("edit-step2").style.display="";}
function editBack(){document.getElementById("edit-step1").style.display="";document.getElementById("edit-step2").style.display="none";}
async function deleteHotel(id,name){if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®ãƒ›ãƒ†ãƒ«ã«ç´ã¥ãæŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚‚å‚ç…§ã§ããªããªã‚Šã¾ã™ã€‚`))return;const{error}=await sb.from("hotels").delete().eq("id",id);if(error){toast("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: "+error.message);return;}hotelsData=hotelsData.filter(h=>h.id!==id);renderHotels();toast("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");}
async function togglePublish(id,current){const newVal=!current;const{error}=await sb.from("hotels").update({is_published:newVal}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+error.message);return;}hotelsData=hotelsData.map(h=>h.id===id?{...h,is_published:newVal}:h);renderHotels();toast(newVal?"âœ… å…¬é–‹ã—ã¾ã—ãŸï¼ˆãƒãƒ¼ã‚¿ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰":"â¸ éå…¬é–‹ã«ã—ã¾ã—ãŸï¼ˆãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰éè¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼‰");}
async function saveHotel(){const id=parseInt(document.getElementById("edit-id").value);const payload={name:document.getElementById("edit-name").value.trim(),hotel_type:document.getElementById("edit-type").value,postal_code:document.getElementById("edit-postal").value.trim()||null,prefecture:document.getElementById("edit-pref").value.trim()||null,city:document.getElementById("edit-city").value.trim()||null,address:document.getElementById("edit-address").value.trim()||null,tel:document.getElementById("edit-tel").value.trim()||null,nearest_station:document.getElementById("edit-station").value.trim()||null,major_area:document.getElementById("edit-major-area").value.trim()||null,detail_area:document.getElementById("edit-detail-area").value.trim()||null,latitude:document.getElementById("edit-lat").value?parseFloat(document.getElementById("edit-lat").value):null,longitude:document.getElementById("edit-lng").value?parseFloat(document.getElementById("edit-lng").value):null,min_charge:document.getElementById("edit-charge").value?parseInt(document.getElementById("edit-charge").value):null};const{error}=await sb.from("hotels").update(payload).eq("id",id);if(error){toast("ä¿å­˜ã‚¨ãƒ©ãƒ¼: "+error.message);return;}hotelsData=hotelsData.map(h=>h.id===id?{...h,...payload}:h);renderHotels();closeModal();toast("âœ… ä¿å­˜ã—ã¾ã—ãŸ");}
function openAddHotel(){
  ["add-name","add-postal","add-pref","add-city","add-address","add-tel","add-station","add-major-area","add-detail-area","add-lat","add-lng","add-charge"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("add-type").value="business";
  document.getElementById("add-step1").style.display="";
  document.getElementById("add-step2").style.display="none";
  document.getElementById("hotel-add-modal").style.display="flex";
}
function closeAddHotel(){document.getElementById("hotel-add-modal").style.display="none";}
function addHotelToConfirm(){
  const name=document.getElementById("add-name").value.trim();
  if(!name){toast("ãƒ›ãƒ†ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  if(!document.getElementById("add-address").value.trim()){toast("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  if(!document.getElementById("add-pref").value.trim()){toast("éƒ½é“åºœçœŒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  const rows=[
    ["ãƒ›ãƒ†ãƒ«å",name],
    ["ã‚¿ã‚¤ãƒ—",HOTEL_TYPE_LABELS[document.getElementById("add-type").value]||"â€”"],
    ["éƒµä¾¿ç•ªå·",document.getElementById("add-postal").value.trim()||"â€”"],
    ["éƒ½é“åºœçœŒ",document.getElementById("add-pref").value.trim()||"â€”"],
    ["å¸‚åŒºç”ºæ‘",document.getElementById("add-city").value.trim()||"â€”"],
    ["ä½æ‰€",document.getElementById("add-address").value.trim()||"â€”"],
    ["é›»è©±ç•ªå·",document.getElementById("add-tel").value.trim()||"â€”"],
    ["æœ€å¯„ã‚Šé§…",document.getElementById("add-station").value.trim()||"â€”"],
    ["ã‚¨ãƒªã‚¢",document.getElementById("add-major-area").value.trim()||"â€”"],
    ["è©³ç´°ã‚¨ãƒªã‚¢",document.getElementById("add-detail-area").value.trim()||"â€”"],
    ["ç·¯åº¦",document.getElementById("add-lat").value||"â€”"],
    ["çµŒåº¦",document.getElementById("add-lng").value||"â€”"],
    ["å‚è€ƒæ–™é‡‘",document.getElementById("add-charge").value?("Â¥"+parseInt(document.getElementById("add-charge").value).toLocaleString()):"â€”"],
  ];
  document.getElementById("add-confirm-body").innerHTML=rows.map(([l,v])=>`<div><span style="color:var(--ink-3);font-size:11px;min-width:80px;display:inline-block;">${l}</span><strong>${esc(v)}</strong></div>`).join("");
  document.getElementById("add-step1").style.display="none";
  document.getElementById("add-step2").style.display="";
}
function addHotelBack(){
  document.getElementById("add-step1").style.display="";
  document.getElementById("add-step2").style.display="none";
}
async function saveNewHotel(){
  const name=document.getElementById("add-name").value.trim();
  if(!name){toast("ãƒ›ãƒ†ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  const payload={
    name,
    hotel_type:document.getElementById("add-type").value,
    postal_code:document.getElementById("add-postal").value.trim()||null,
    prefecture:document.getElementById("add-pref").value.trim()||null,
    city:document.getElementById("add-city").value.trim()||null,
    address:document.getElementById("add-address").value.trim()||null,
    tel:document.getElementById("add-tel").value.trim()||null,
    nearest_station:document.getElementById("add-station").value.trim()||null,
    major_area:document.getElementById("add-major-area").value.trim()||null,
    detail_area:document.getElementById("add-detail-area").value.trim()||null,
    latitude:document.getElementById("add-lat").value?parseFloat(document.getElementById("add-lat").value):null,
    longitude:document.getElementById("add-lng").value?parseFloat(document.getElementById("add-lng").value):null,
    min_charge:document.getElementById("add-charge").value?parseInt(document.getElementById("add-charge").value):null,
    source:"manual",
    is_published:false
  };
  const{data,error}=await sb.from("hotels").insert(payload).select().single();
  if(error){console.error("[saveNewHotel]",error);toast("è¿½åŠ ã‚¨ãƒ©ãƒ¼: "+error.message);return;}
  hotelsData.unshift(data);renderHotels();closeAddHotel();toast("âœ… ãƒ›ãƒ†ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆéå…¬é–‹ï¼‰ã€‚å…¬é–‹ã™ã‚‹ã«ã¯ãƒ›ãƒ†ãƒ«ä¸€è¦§ã‹ã‚‰å…¬é–‹è¨­å®šã—ã¦ãã ã•ã„ã€‚");
}

// ===== ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå‘¼ã¹ãŸç†ç”± / å‘¼ã¹ãªã‹ã£ãŸç†ç”± / éƒ¨å±‹ã‚¿ã‚¤ãƒ—ï¼‰ =====
let canReasonsData=[];
async function loadCanReasons(){const{data,error}=await sb.from("can_call_reasons").select("*").order("sort_order");if(error){if(error.code==="PGRST205")return showTableMissing("can-reasons-list","can-reasons-sub","can_call_reasons",SQL_CAN_REASONS);toast("å–å¾—ã‚¨ãƒ©ãƒ¼: "+error.message);return;}canReasonsData=data||[];renderCanReasons();}
function renderCanReasons(){document.getElementById("can-reasons-sub").textContent=`å…¨ ${canReasonsData.length} ä»¶`;document.getElementById("can-reasons-list").innerHTML=canReasonsData.length===0?`<div style="text-align:center;padding:20px;color:var(--ink-3);font-size:13px;">ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`:canReasonsData.map(c=>`<div class="cond-row" draggable="true" ondragstart="dndStart(event,${c.id},'can_call_reasons')" ondragover="dndOver(event)" ondragleave="dndLeave(event)" ondragend="dndEnd(event)" ondrop="dndDrop(event,${c.id})"><span class="drag-handle">&#9776;</span><span class="cond-order">${c.sort_order}</span><span class="cond-label">${esc(c.label)}</span><button class="btn b-btn-gold" onclick="editCanReason(${c.id},'${esc(c.label)}')">ç·¨é›†</button><button class="btn b-btn-red" onclick="deleteCanReason(${c.id},'${esc(c.label)}')">å‰Šé™¤</button></div>`).join("");}
async function addCanReason(){const input=document.getElementById("new-can-reason");const label=input.value.trim();if(!label){toast("ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}const maxOrder=canReasonsData.length?Math.max(...canReasonsData.map(c=>c.sort_order))+1:1;const{data,error}=await sb.from("can_call_reasons").insert({label,sort_order:maxOrder}).select().single();if(error){toast(error.code==="23505"?"åŒã˜åå‰ãŒæ—¢ã«ã‚ã‚Šã¾ã™":"è¿½åŠ ã‚¨ãƒ©ãƒ¼");return;}canReasonsData.push(data);renderCanReasons();input.value="";toast("âœ… è¿½åŠ ã—ã¾ã—ãŸ");}
async function editCanReason(id,label){const newLabel=prompt("ç†ç”±ã‚’ç·¨é›†ã—ã¦ãã ã•ã„:",label);if(!newLabel||newLabel.trim()===label)return;const{error}=await sb.from("can_call_reasons").update({label:newLabel.trim()}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼");return;}canReasonsData=canReasonsData.map(c=>c.id===id?{...c,label:newLabel.trim()}:c);renderCanReasons();toast("âœ… æ›´æ–°ã—ã¾ã—ãŸ");}
async function deleteCanReason(id,label){if(!confirm(`ã€Œ${label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;const{error}=await sb.from("can_call_reasons").delete().eq("id",id);if(error){toast("å‰Šé™¤ã‚¨ãƒ©ãƒ¼");return;}canReasonsData=canReasonsData.filter(c=>c.id!==id);renderCanReasons();toast("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");}
let cannotReasonsData=[];
async function loadCannotReasons(){const{data,error}=await sb.from("cannot_call_reasons").select("*").order("sort_order");if(error){if(error.code==="PGRST205")return showTableMissing("cannot-reasons-list","cannot-reasons-sub","cannot_call_reasons",SQL_CANNOT_REASONS);toast("å–å¾—ã‚¨ãƒ©ãƒ¼: "+error.message);return;}cannotReasonsData=data||[];renderCannotReasons();}
function renderCannotReasons(){document.getElementById("cannot-reasons-sub").textContent=`å…¨ ${cannotReasonsData.length} ä»¶`;document.getElementById("cannot-reasons-list").innerHTML=cannotReasonsData.length===0?`<div style="text-align:center;padding:20px;color:var(--ink-3);font-size:13px;">ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`:cannotReasonsData.map(c=>`<div class="cond-row" draggable="true" ondragstart="dndStart(event,${c.id},'cannot_call_reasons')" ondragover="dndOver(event)" ondragleave="dndLeave(event)" ondragend="dndEnd(event)" ondrop="dndDrop(event,${c.id})"><span class="drag-handle">&#9776;</span><span class="cond-order">${c.sort_order}</span><span class="cond-label">${esc(c.label)}</span><button class="btn b-btn-gold" onclick="editCannotReason(${c.id},'${esc(c.label)}')">ç·¨é›†</button><button class="btn b-btn-red" onclick="deleteCannotReason(${c.id},'${esc(c.label)}')">å‰Šé™¤</button></div>`).join("");}
async function addCannotReason(){const input=document.getElementById("new-cannot-reason");const label=input.value.trim();if(!label){toast("ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}const maxOrder=cannotReasonsData.length?Math.max(...cannotReasonsData.map(c=>c.sort_order))+1:1;const{data,error}=await sb.from("cannot_call_reasons").insert({label,sort_order:maxOrder}).select().single();if(error){toast(error.code==="23505"?"åŒã˜åå‰ãŒæ—¢ã«ã‚ã‚Šã¾ã™":"è¿½åŠ ã‚¨ãƒ©ãƒ¼");return;}cannotReasonsData.push(data);renderCannotReasons();input.value="";toast("âœ… è¿½åŠ ã—ã¾ã—ãŸ");}
async function editCannotReason(id,label){const newLabel=prompt("ç†ç”±ã‚’ç·¨é›†ã—ã¦ãã ã•ã„:",label);if(!newLabel||newLabel.trim()===label)return;const{error}=await sb.from("cannot_call_reasons").update({label:newLabel.trim()}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼");return;}cannotReasonsData=cannotReasonsData.map(c=>c.id===id?{...c,label:newLabel.trim()}:c);renderCannotReasons();toast("âœ… æ›´æ–°ã—ã¾ã—ãŸ");}
async function deleteCannotReason(id,label){if(!confirm(`ã€Œ${label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;const{error}=await sb.from("cannot_call_reasons").delete().eq("id",id);if(error){toast("å‰Šé™¤ã‚¨ãƒ©ãƒ¼");return;}cannotReasonsData=cannotReasonsData.filter(c=>c.id!==id);renderCannotReasons();toast("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");}
let roomTypesData=[];
async function loadRoomTypes(){const{data,error}=await sb.from("room_types").select("*").order("sort_order");if(error){if(error.code==="PGRST205")return showTableMissing("room-types-list","room-types-sub","room_types",SQL_ROOM_TYPES);toast("å–å¾—ã‚¨ãƒ©ãƒ¼: "+error.message);return;}roomTypesData=data||[];renderRoomTypes();}
function renderRoomTypes(){document.getElementById("room-types-sub").textContent=`å…¨ ${roomTypesData.length} ä»¶`;document.getElementById("room-types-list").innerHTML=roomTypesData.length===0?`<div style="text-align:center;padding:20px;color:var(--ink-3);font-size:13px;">ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`:roomTypesData.map(c=>`<div class="cond-row" draggable="true" ondragstart="dndStart(event,${c.id},'room_types')" ondragover="dndOver(event)" ondragleave="dndLeave(event)" ondragend="dndEnd(event)" ondrop="dndDrop(event,${c.id})"><span class="drag-handle">&#9776;</span><span class="cond-order">${c.sort_order}</span><span class="cond-label">${esc(c.label)}</span><button class="btn b-btn-gold" onclick="editRoomType(${c.id},'${esc(c.label)}')">ç·¨é›†</button><button class="btn b-btn-red" onclick="deleteRoomType(${c.id},'${esc(c.label)}')">å‰Šé™¤</button></div>`).join("");}
async function addRoomType(){const input=document.getElementById("new-room-type");const label=input.value.trim();if(!label){toast("ã‚¿ã‚¤ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}const maxOrder=roomTypesData.length?Math.max(...roomTypesData.map(c=>c.sort_order))+1:1;const{data,error}=await sb.from("room_types").insert({label,sort_order:maxOrder}).select().single();if(error){toast(error.code==="23505"?"åŒã˜åå‰ãŒæ—¢ã«ã‚ã‚Šã¾ã™":"è¿½åŠ ã‚¨ãƒ©ãƒ¼");return;}roomTypesData.push(data);renderRoomTypes();input.value="";toast("âœ… è¿½åŠ ã—ã¾ã—ãŸ");}
async function editRoomType(id,label){const newLabel=prompt("ã‚¿ã‚¤ãƒ—åã‚’ç·¨é›†ã—ã¦ãã ã•ã„:",label);if(!newLabel||newLabel.trim()===label)return;const{error}=await sb.from("room_types").update({label:newLabel.trim()}).eq("id",id);if(error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼");return;}roomTypesData=roomTypesData.map(c=>c.id===id?{...c,label:newLabel.trim()}:c);renderRoomTypes();toast("âœ… æ›´æ–°ã—ã¾ã—ãŸ");}
async function deleteRoomType(id,label){if(!confirm(`ã€Œ${label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;const{error}=await sb.from("room_types").delete().eq("id",id);if(error){toast("å‰Šé™¤ã‚¨ãƒ©ãƒ¼");return;}roomTypesData=roomTypesData.filter(c=>c.id!==id);renderRoomTypes();toast("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");}

// ===== æ²è¼‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ =====
const HREQ_TYPE_LABELS={business:"ãƒ“ã‚¸ãƒã‚¹",city:"ã‚·ãƒ†ã‚£",resort:"ãƒªã‚¾ãƒ¼ãƒˆ",ryokan:"æ—…é¤¨",pension:"ãƒšãƒ³ã‚·ãƒ§ãƒ³",minshuku:"æ°‘å®¿",other:"ãã®ä»–"};
let hotelRequestsData=[];

async function loadHotelRequests(){
  const{data,error}=await sb.from("hotel_requests").select("*").order("created_at",{ascending:false});
  if(error){if(error.code==="PGRST205")return showTableMissing("hreq-tbody","hreq-sub","hotel_requests",SQL_HOTEL_REQUESTS);toast("å–å¾—ã‚¨ãƒ©ãƒ¼: "+error.message);return;}
  hotelRequestsData=data||[];
  updateHreqBadge();renderHotelRequests();
}

function updateHreqBadge(){const count=hotelRequestsData.filter(r=>r.status==="pending").length;const b=document.getElementById("hreq-badge");if(count>0){b.style.display="inline";b.textContent=count;}else b.style.display="none";}

function renderHotelRequests(){
  const fF=document.getElementById("hreq-status-f").value;
  let data=hotelRequestsData.filter(r=>!fF||r.status===fF);
  data=applySortArr(data,"hreq");
  document.getElementById("hreq-sub").textContent=data.length+" ä»¶";
  if(data.length===0){
    document.getElementById("hreq-tbody").innerHTML='<tr class="erow"><td colspan="7">ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    return;
  }
  document.getElementById("hreq-tbody").innerHTML=data.map(function(r){
    var id=String(r.id);
    var isConfirmed=r.status==="confirmed";
    var statusBadge=isConfirmed?'<span class="badge b-active">âœ“ ç¢ºèªæ¸ˆ</span>':'<span class="badge b-free">æœªç¢ºèª</span>';
    var toggleBtn=isConfirmed
      ?'<button class="btn b-btn-gray" onclick="toggleHreqStatus(\''+id+'\')">æœªç¢ºèªã«æˆ»ã™</button>'
      :'<button class="btn b-btn-green" onclick="toggleHreqStatus(\''+id+'\')">ç¢ºèªæ¸ˆ</button>';
    var actionBtns='<div class="btn-row">'+toggleBtn
      +'<button class="btn b-btn-gold" onclick="openHreqEdit(\''+id+'\')">ç·¨é›†â†’ç™»éŒ²</button>'
      +'<button class="btn b-btn-red" onclick="deleteHotelRequest(\''+id+'\')">å‰Šé™¤</button>'
      +'</div>';
    return '<tr>'
      +'<td style="color:var(--ink-3);font-size:11px;white-space:nowrap;">'+fmtShort(r.created_at)+'</td>'
      +'<td style="font-weight:500;font-size:13px;">'+esc(r.hotel_name||"â€”")+'</td>'
      +'<td style="font-size:11px;color:var(--ink-3);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+esc(r.address||"â€”")+'</td>'
      +'<td style="font-size:11px;color:var(--ink-3);">'+esc(r.tel||"â€”")+'</td>'
      +'<td style="font-size:11px;">'+esc(HREQ_TYPE_LABELS[r.hotel_type]||r.hotel_type||"â€”")+'</td>'
      +'<td>'+statusBadge+'</td>'
      +'<td>'+actionBtns+'</td>'
      +'</tr>';
  }).join("");
}

async function toggleHreqStatus(id){
  var r=hotelRequestsData.find(function(r){return String(r.id)===id;});
  if(!r){toast("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return;}
  var newStatus=r.status==="pending"?"confirmed":"pending";
  var res=await sb.from("hotel_requests").update({status:newStatus}).eq("id",r.id);
  if(res.error){toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+res.error.message);return;}
  hotelRequestsData=hotelRequestsData.map(function(x){return String(x.id)===id?Object.assign({},x,{status:newStatus}):x;});
  updateHreqBadge();renderHotelRequests();
  toast(newStatus==="confirmed"?"âœ… ç¢ºèªæ¸ˆã«ã—ã¾ã—ãŸ":"ğŸ”„ æœªç¢ºèªã«æˆ»ã—ã¾ã—ãŸ");
}

function openHreqEdit(id){
  var r=hotelRequestsData.find(function(r){return String(r.id)===id;});
  if(!r){toast("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return;}
  document.getElementById("hreq-edit-id").value=id;
  document.getElementById("hreq-edit-label").textContent=r.hotel_name||"";
  document.getElementById("hreq-edit-name").value=r.hotel_name||"";
  document.getElementById("hreq-edit-address").value=r.address||"";
  document.getElementById("hreq-edit-tel").value=r.tel||"";
  document.getElementById("hreq-edit-type").value=r.hotel_type||"other";
  document.getElementById("hreq-edit-pref").value="";
  document.getElementById("hreq-edit-area").value="";
  document.getElementById("hreq-edit-station").value="";
  document.getElementById("hreq-step1").style.display="";
  document.getElementById("hreq-step2").style.display="none";
  document.getElementById("hreq-edit-modal").style.display="flex";
}

function closeHreqEdit(){document.getElementById("hreq-edit-modal").style.display="none";}

function hreqEditToConfirm(){
  var name=document.getElementById("hreq-edit-name").value.trim();
  if(!name){toast("ãƒ›ãƒ†ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  var typeLabels={business:"ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«",city:"ã‚·ãƒ†ã‚£ãƒ›ãƒ†ãƒ«",resort:"ãƒªã‚¾ãƒ¼ãƒˆãƒ›ãƒ†ãƒ«",ryokan:"æ—…é¤¨",pension:"ãƒšãƒ³ã‚·ãƒ§ãƒ³",minshuku:"æ°‘å®¿",other:"ãã®ä»–"};
  var rows=[
    ["ãƒ›ãƒ†ãƒ«å",name],
    ["ä½æ‰€",document.getElementById("hreq-edit-address").value.trim()||"â€”"],
    ["é›»è©±ç•ªå·",document.getElementById("hreq-edit-tel").value.trim()||"â€”"],
    ["ã‚¿ã‚¤ãƒ—",typeLabels[document.getElementById("hreq-edit-type").value]||"â€”"],
    ["éƒ½é“åºœçœŒ",document.getElementById("hreq-edit-pref").value.trim()||"â€”"],
    ["ã‚¨ãƒªã‚¢",document.getElementById("hreq-edit-area").value.trim()||"â€”"],
    ["æœ€å¯„ã‚Šé§…",document.getElementById("hreq-edit-station").value.trim()||"â€”"],
  ];
  document.getElementById("hreq-confirm-body").innerHTML=rows.map(function(row){return'<div><span style="color:var(--ink-3);font-size:11px;min-width:80px;display:inline-block;">'+row[0]+'</span><strong>'+esc(row[1])+'</strong></div>';}).join("");
  document.getElementById("hreq-step1").style.display="none";
  document.getElementById("hreq-step2").style.display="";
}

function hreqEditBack(){
  document.getElementById("hreq-step1").style.display="";
  document.getElementById("hreq-step2").style.display="none";
}

async function saveHreqAsHotel(){
  var id=document.getElementById("hreq-edit-id").value;
  var name=document.getElementById("hreq-edit-name").value.trim();
  if(!name){toast("ãƒ›ãƒ†ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  var payload={
    name:name,
    address:document.getElementById("hreq-edit-address").value.trim()||null,
    tel:document.getElementById("hreq-edit-tel").value.trim()||null,
    hotel_type:document.getElementById("hreq-edit-type").value||"other",
    prefecture:document.getElementById("hreq-edit-pref").value.trim()||null,
    major_area:document.getElementById("hreq-edit-area").value.trim()||null,
    nearest_station:document.getElementById("hreq-edit-station").value.trim()||null,
    source:"manual",
    is_published:false
  };
  console.log("[saveHreqAsHotel] payload:",payload,"hreq_id:",id);
  var r1=await sb.from("hotels").insert(payload).select().single();
  if(r1.error){console.error("[saveHreqAsHotel] hotels insert error:",r1.error,"payload:",payload);toast("ãƒ›ãƒ†ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼: "+r1.error.message);return;}
  var r2=await sb.from("hotel_requests").update({status:"confirmed"}).eq("id",id);
  if(r2.error){console.error("[saveHreqAsHotel] hotel_requests update error:",r2.error);toast("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼: "+r2.error.message);return;}
  hotelRequestsData=hotelRequestsData.map(function(r){return String(r.id)===id?Object.assign({},r,{status:"confirmed"}):r;});
  updateHreqBadge();renderHotelRequests();closeHreqEdit();
  toast("âœ… ãƒ›ãƒ†ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆéå…¬é–‹ï¼‰ã€‚å…¬é–‹ã™ã‚‹ã«ã¯ãƒ›ãƒ†ãƒ«ä¸€è¦§ã‹ã‚‰å…¬é–‹è¨­å®šã—ã¦ãã ã•ã„ã€‚");
}

async function deleteHotelRequest(id){
  var r=hotelRequestsData.find(function(r){return String(r.id)===id;});
  if(!r){toast("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return;}
  if(!confirm("ã€Œ"+r.hotel_name+"ã€ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
  var res=await sb.from("hotel_requests").delete().eq("id",r.id);
  if(res.error){toast("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: "+res.error.message);return;}
  hotelRequestsData=hotelRequestsData.filter(function(r){return String(r.id)!==id;});
  updateHreqBadge();renderHotelRequests();
  toast("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");
}

// ===== ãƒ†ãƒ¼ãƒ–ãƒ«æœªä½œæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ =====
const SQL_CAN_REASONS=`CREATE TABLE public.can_call_reasons (
  id BIGSERIAL PRIMARY KEY,
  label TEXT NOT NULL UNIQUE,
  sort_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.can_call_reasons ENABLE ROW LEVEL SECURITY;
CREATE POLICY "public_read" ON public.can_call_reasons FOR SELECT USING (true);
INSERT INTO public.can_call_reasons (label, sort_order) VALUES
  ('ç›´é€š',1),('ã‚«ãƒ¼ãƒ‰ã‚­ãƒ¼å¿…é ˆ',2),('EVãƒ•ãƒ­ãƒ³ãƒˆéšã‚¹ã‚­ãƒƒãƒ—',3),
  ('ãƒ•ãƒ­ãƒ³ãƒˆç›¸è«‡',4),('ãƒã‚¦ãƒã‚¦',5),('ãƒã‚¹ã‚¿ã‚ªãƒ«ä¾é ¼æ¨å¥¨',6),('ç„é–¢å¾…ã¡åˆã‚ã›',7);`;
const SQL_CANNOT_REASONS=`CREATE TABLE public.cannot_call_reasons (
  id BIGSERIAL PRIMARY KEY,
  label TEXT NOT NULL UNIQUE,
  sort_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.cannot_call_reasons ENABLE ROW LEVEL SECURITY;
CREATE POLICY "public_read" ON public.cannot_call_reasons FOR SELECT USING (true);`;
const SQL_ROOM_TYPES=`CREATE TABLE public.room_types (
  id BIGSERIAL PRIMARY KEY,
  label TEXT NOT NULL UNIQUE,
  sort_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.room_types ENABLE ROW LEVEL SECURITY;
CREATE POLICY "public_read" ON public.room_types FOR SELECT USING (true);
INSERT INTO public.room_types (label, sort_order) VALUES
  ('ã‚·ãƒ³ã‚°ãƒ«',1),('ãƒ€ãƒ–ãƒ«',2),('ãƒ„ã‚¤ãƒ³',3),('å’Œå®¤',4),('ã‚¹ã‚¤ãƒ¼ãƒˆ',5);`;
const SQL_HOTEL_REQUESTS=`CREATE TABLE public.hotel_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  hotel_name TEXT NOT NULL,
  address TEXT,
  tel TEXT,
  hotel_type TEXT DEFAULT 'other',
  status TEXT NOT NULL DEFAULT 'pending',
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.hotel_requests ENABLE ROW LEVEL SECURITY;
CREATE POLICY "public_read" ON public.hotel_requests FOR SELECT USING (true);
CREATE POLICY "public_insert" ON public.hotel_requests FOR INSERT WITH CHECK (true);
CREATE POLICY "admin_update" ON public.hotel_requests FOR UPDATE USING (true);
CREATE POLICY "admin_delete" ON public.hotel_requests FOR DELETE USING (true);`;
const _sqlMap={can_call_reasons:SQL_CAN_REASONS,cannot_call_reasons:SQL_CANNOT_REASONS,room_types:SQL_ROOM_TYPES,hotel_requests:SQL_HOTEL_REQUESTS};
function copyTableSQL(t){navigator.clipboard.writeText(_sqlMap[t]||"").then(()=>toast("âœ… SQLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")).catch(()=>toast("ã‚³ãƒ”ãƒ¼å¤±æ•—"));}
function showTableMissing(listId,subId,tableName,sql){const sub=document.getElementById(subId);if(sub)sub.textContent="âš ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«æœªä½œæˆ";const el=document.getElementById(listId);if(!el)return;el.innerHTML=`<div style="padding:16px;background:rgba(192,80,80,0.06);border:1px solid rgba(192,80,80,0.22);border-radius:8px;margin-bottom:4px;"><div style="font-size:13px;font-weight:700;color:var(--red);margin-bottom:8px;">âš ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ (public.${tableName})</div><div style="font-size:12px;color:var(--ink-3);margin-bottom:10px;">Supabase Dashboard â†’ SQL Editor ã§ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚å®Ÿè¡Œå¾Œã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div><pre style="background:#1a1a1a;color:#bbb;padding:12px;border-radius:6px;font-size:11px;overflow-x:auto;white-space:pre-wrap;word-break:break-all;margin-bottom:8px;">${esc(sql)}</pre><button class="btn b-btn-gold" onclick="copyTableSQL('${tableName}')">ğŸ“‹ SQLã‚’ã‚³ãƒ”ãƒ¼</button></div>`;}

// ===== ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆãƒã‚¹ã‚¿ãƒ¼ä¸¦ã³æ›¿ãˆï¼‰ =====
let _dndSrcId=null,_dndTable=null;
function dndStart(e,id,table){_dndSrcId=id;_dndTable=table;e.currentTarget.classList.add("dragging");e.dataTransfer.effectAllowed="move";}
function dndOver(e){e.preventDefault();e.currentTarget.classList.add("drag-over");}
function dndLeave(e){e.currentTarget.classList.remove("drag-over");}
function dndEnd(e){e.currentTarget.classList.remove("dragging");document.querySelectorAll(".cond-row.drag-over").forEach(el=>el.classList.remove("drag-over"));}
async function dndDrop(e,targetId){e.preventDefault();e.currentTarget.classList.remove("drag-over");document.querySelectorAll(".cond-row.dragging").forEach(el=>el.classList.remove("dragging"));if(_dndSrcId===null||_dndSrcId===targetId)return;let dataArr,renderFn;if(_dndTable==="can_call_reasons"){dataArr=canReasonsData;renderFn=renderCanReasons;}else if(_dndTable==="cannot_call_reasons"){dataArr=cannotReasonsData;renderFn=renderCannotReasons;}else if(_dndTable==="room_types"){dataArr=roomTypesData;renderFn=renderRoomTypes;}else return;const srcIdx=dataArr.findIndex(c=>c.id===_dndSrcId);const tgtIdx=dataArr.findIndex(c=>c.id===targetId);if(srcIdx<0||tgtIdx<0)return;const[moved]=dataArr.splice(srcIdx,1);dataArr.splice(tgtIdx,0,moved);dataArr.forEach((c,i)=>c.sort_order=i+1);renderFn();const results=await Promise.all(dataArr.map(c=>sb.from(_dndTable).update({sort_order:c.sort_order}).eq("id",c.id)));if(results.some(r=>r.error))toast("âš ï¸ ä¸¦ã³æ›¿ãˆã‚¨ãƒ©ãƒ¼");else toast("âœ… é †ç•ªã‚’ä¿å­˜ã—ã¾ã—ãŸ");}
</script>
</body>
</html>
